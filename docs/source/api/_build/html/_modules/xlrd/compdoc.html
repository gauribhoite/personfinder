<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>xlrd.compdoc &mdash; app  documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="app  documentation" href="../../index.html" />
    <link rel="up" title="xlrd" href="../xlrd.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for xlrd.compdoc</h1><div class="highlight"><pre>
<span class="c"># -*- coding: cp1252 -*-</span>

<span class="c">##</span>
<span class="c"># Implements the minimal functionality required</span>
<span class="c"># to extract a &quot;Workbook&quot; or &quot;Book&quot; stream (as one big string)</span>
<span class="c"># from an OLE2 Compound Document file.</span>
<span class="c"># &lt;p&gt;Copyright ï¿½ 2005-2012 Stephen John Machin, Lingfo Pty Ltd&lt;/p&gt;</span>
<span class="c"># &lt;p&gt;This module is part of the xlrd package, which is released under a BSD-style licence.&lt;/p&gt;</span>
<span class="c">##</span>

<span class="c"># No part of the content of this file was derived from the works of David Giffin.</span>

<span class="c"># 2008-11-04 SJM Avoid assertion error when -1 used instead of -2 for first_SID of empty SCSS [Frank Hoffsuemmer]</span>
<span class="c"># 2007-09-08 SJM Warning message if sector sizes are extremely large.</span>
<span class="c"># 2007-05-07 SJM Meaningful exception instead of IndexError if a SAT (sector allocation table) is corrupted.</span>
<span class="c"># 2007-04-22 SJM Missing &quot;&lt;&quot; in a struct.unpack call =&gt; can&#39;t open files on bigendian platforms.</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">unpack</span>
<span class="kn">from</span> <span class="nn">.timemachine</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">array</span>

<span class="c">##</span>
<span class="c"># Magic cookie that should appear in the first 8 bytes of the file.</span>
<span class="n">SIGNATURE</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;</span><span class="se">\xD0\xCF\x11\xE0\xA1\xB1\x1A\xE1</span><span class="s">&quot;</span>

<span class="n">EOCSID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
<span class="n">FREESID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">SATSID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span>
<span class="n">MSATSID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span>
<span class="n">EVILSID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span>

<div class="viewcode-block" id="CompDocError"><a class="viewcode-back" href="../../xlrd.html#xlrd.compdoc.CompDocError">[docs]</a><span class="k">class</span> <span class="nc">CompDocError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="DirNode"><a class="viewcode-back" href="../../xlrd.html#xlrd.compdoc.DirNode">[docs]</a><span class="k">class</span> <span class="nc">DirNode</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">DID</span><span class="p">,</span> <span class="n">dent</span><span class="p">,</span> <span class="n">DEBUG</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="c"># dent is the 128-byte directory entry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DID</span> <span class="o">=</span> <span class="n">DID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="o">=</span> <span class="n">logfile</span>
        <span class="p">(</span><span class="n">cbufsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">etype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_DID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_DID</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_DID</span><span class="p">)</span> <span class="o">=</span> \
            <span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&lt;HBBiii&#39;</span><span class="p">,</span> <span class="n">dent</span><span class="p">[</span><span class="mi">64</span><span class="p">:</span><span class="mi">80</span><span class="p">])</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">first_SID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_size</span><span class="p">)</span> <span class="o">=</span> \
            <span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&lt;ii&#39;</span><span class="p">,</span> <span class="n">dent</span><span class="p">[</span><span class="mi">116</span><span class="p">:</span><span class="mi">124</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">cbufsize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">UNICODE_LITERAL</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">dent</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">cbufsize</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="s">&#39;utf_16_le&#39;</span><span class="p">)</span> <span class="c"># omit the trailing U+0000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># filled in later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># indicates orphan; fixed up later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsinfo</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&lt;IIII&#39;</span><span class="p">,</span> <span class="n">dent</span><span class="p">[</span><span class="mi">100</span><span class="p">:</span><span class="mi">116</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span>

<div class="viewcode-block" id="DirNode.dump"><a class="viewcode-back" href="../../xlrd.html#xlrd.compdoc.DirNode.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">DEBUG</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">fprintf</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span>
            <span class="s">&quot;DID=</span><span class="si">%d</span><span class="s"> name=</span><span class="si">%r</span><span class="s"> etype=</span><span class="si">%d</span><span class="s"> DIDs(left=</span><span class="si">%d</span><span class="s"> right=</span><span class="si">%d</span><span class="s"> root=</span><span class="si">%d</span><span class="s"> parent=</span><span class="si">%d</span><span class="s"> kids=</span><span class="si">%r</span><span class="s">) first_SID=</span><span class="si">%d</span><span class="s"> tot_size=</span><span class="si">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">DID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">etype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_DID</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">right_DID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_DID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_SID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_size</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">DEBUG</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c"># cre_lo, cre_hi, mod_lo, mod_hi = tsinfo</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;timestamp info&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsinfo</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="p">)</span>
</div></div>
<span class="k">def</span> <span class="nf">_build_family_tree</span><span class="p">(</span><span class="n">dirlist</span><span class="p">,</span> <span class="n">parent_DID</span><span class="p">,</span> <span class="n">child_DID</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">child_DID</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span>
    <span class="n">_build_family_tree</span><span class="p">(</span><span class="n">dirlist</span><span class="p">,</span> <span class="n">parent_DID</span><span class="p">,</span> <span class="n">dirlist</span><span class="p">[</span><span class="n">child_DID</span><span class="p">]</span><span class="o">.</span><span class="n">left_DID</span><span class="p">)</span>
    <span class="n">dirlist</span><span class="p">[</span><span class="n">parent_DID</span><span class="p">]</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child_DID</span><span class="p">)</span>
    <span class="n">dirlist</span><span class="p">[</span><span class="n">child_DID</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent_DID</span>
    <span class="n">_build_family_tree</span><span class="p">(</span><span class="n">dirlist</span><span class="p">,</span> <span class="n">parent_DID</span><span class="p">,</span> <span class="n">dirlist</span><span class="p">[</span><span class="n">child_DID</span><span class="p">]</span><span class="o">.</span><span class="n">right_DID</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dirlist</span><span class="p">[</span><span class="n">child_DID</span><span class="p">]</span><span class="o">.</span><span class="n">etype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># storage</span>
        <span class="n">_build_family_tree</span><span class="p">(</span><span class="n">dirlist</span><span class="p">,</span> <span class="n">child_DID</span><span class="p">,</span> <span class="n">dirlist</span><span class="p">[</span><span class="n">child_DID</span><span class="p">]</span><span class="o">.</span><span class="n">root_DID</span><span class="p">)</span>

<span class="c">##</span>
<span class="c"># Compound document handler.</span>
<span class="c"># @param mem The raw contents of the file, as a string, or as an mmap.mmap() object. The</span>
<span class="c"># only operation it needs to support is slicing.</span>

<div class="viewcode-block" id="CompDoc"><a class="viewcode-back" href="../../xlrd.html#xlrd.compdoc.CompDoc">[docs]</a><span class="k">class</span> <span class="nc">CompDoc</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">DEBUG</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="o">=</span> <span class="n">logfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DEBUG</span> <span class="o">=</span> <span class="n">DEBUG</span>
        <span class="k">if</span> <span class="n">mem</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SIGNATURE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CompDocError</span><span class="p">(</span><span class="s">&#39;Not an OLE2 compound document&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mem</span><span class="p">[</span><span class="mi">28</span><span class="p">:</span><span class="mi">30</span><span class="p">]</span> <span class="o">!=</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\xFE\xFF</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CompDocError</span><span class="p">(</span><span class="s">&#39;Expected &quot;little-endian&quot; marker, found </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">mem</span><span class="p">[</span><span class="mi">28</span><span class="p">:</span><span class="mi">30</span><span class="p">])</span>
        <span class="n">revision</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&lt;HH&#39;</span><span class="p">,</span> <span class="n">mem</span><span class="p">[</span><span class="mi">24</span><span class="p">:</span><span class="mi">28</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">CompDoc format: version=0x</span><span class="si">%04x</span><span class="s"> revision=0x</span><span class="si">%04x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">revision</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mem</span> <span class="o">=</span> <span class="n">mem</span>
        <span class="n">ssz</span><span class="p">,</span> <span class="n">sssz</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&lt;HH&#39;</span><span class="p">,</span> <span class="n">mem</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">34</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ssz</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span> <span class="c"># allows for 2**20 bytes i.e. 1MB</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;WARNING: sector size (2**</span><span class="si">%d</span><span class="s">) is preposterous; assuming 512 and continuing ...&quot;</span> \
                <span class="o">%</span> <span class="n">ssz</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
            <span class="n">ssz</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="k">if</span> <span class="n">sssz</span> <span class="o">&gt;</span> <span class="n">ssz</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;WARNING: short stream sector size (2**</span><span class="si">%d</span><span class="s">) is preposterous; assuming 64 and continuing ...&quot;</span> \
                <span class="o">%</span> <span class="n">sssz</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
            <span class="n">sssz</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sec_size</span> <span class="o">=</span> <span class="n">sec_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ssz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">short_sec_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sssz</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sec_size</span> <span class="o">!=</span> <span class="mi">512</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_sec_size</span> <span class="o">!=</span> <span class="mi">64</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;@@@@ sec_size=</span><span class="si">%d</span><span class="s"> short_sec_size=</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sec_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_sec_size</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
        <span class="p">(</span>
            <span class="n">SAT_tot_secs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_first_sec_sid</span><span class="p">,</span> <span class="n">_unused</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_size_std_stream</span><span class="p">,</span>
            <span class="n">SSAT_first_sec_sid</span><span class="p">,</span> <span class="n">SSAT_tot_secs</span><span class="p">,</span>
            <span class="n">MSATX_first_sec_sid</span><span class="p">,</span> <span class="n">MSATX_tot_secs</span><span class="p">,</span>
        <span class="c"># ) = unpack(&#39;&lt;ii4xiiiii&#39;, mem[44:76])</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&lt;iiiiiiii&#39;</span><span class="p">,</span> <span class="n">mem</span><span class="p">[</span><span class="mi">44</span><span class="p">:</span><span class="mi">76</span><span class="p">])</span>
        <span class="n">mem_data_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span> <span class="o">-</span> <span class="mi">512</span>
        <span class="n">mem_data_secs</span><span class="p">,</span> <span class="n">left_over</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">mem_data_len</span><span class="p">,</span> <span class="n">sec_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">left_over</span><span class="p">:</span>
            <span class="c">#### raise CompDocError(&quot;Not a whole number of sectors&quot;)</span>
            <span class="n">mem_data_secs</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;WARNING *** file size (</span><span class="si">%d</span><span class="s">) not 512 + multiple of sector size (</span><span class="si">%d</span><span class="s">)&quot;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mem</span><span class="p">),</span> <span class="n">sec_size</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mem_data_secs</span> <span class="o">=</span> <span class="n">mem_data_secs</span> <span class="c"># use for checking later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mem_data_len</span> <span class="o">=</span> <span class="n">mem_data_len</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">mem_data_secs</span>

        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;sec sizes&#39;</span><span class="p">,</span> <span class="n">ssz</span><span class="p">,</span> <span class="n">sssz</span><span class="p">,</span> <span class="n">sec_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_sec_size</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;mem data: </span><span class="si">%d</span><span class="s"> bytes == </span><span class="si">%d</span><span class="s"> sectors&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mem_data_len</span><span class="p">,</span> <span class="n">mem_data_secs</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;SAT_tot_secs=</span><span class="si">%d</span><span class="s">, dir_first_sec_sid=</span><span class="si">%d</span><span class="s">, min_size_std_stream=</span><span class="si">%d</span><span class="s">&quot;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">SAT_tot_secs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_first_sec_sid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_size_std_stream</span><span class="p">,),</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;SSAT_first_sec_sid=</span><span class="si">%d</span><span class="s">, SSAT_tot_secs=</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">SSAT_first_sec_sid</span><span class="p">,</span> <span class="n">SSAT_tot_secs</span><span class="p">,),</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;MSATX_first_sec_sid=</span><span class="si">%d</span><span class="s">, MSATX_tot_secs=</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MSATX_first_sec_sid</span><span class="p">,</span> <span class="n">MSATX_tot_secs</span><span class="p">,),</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
        <span class="n">nent</span> <span class="o">=</span> <span class="n">sec_size</span> <span class="o">//</span> <span class="mi">4</span> <span class="c"># number of SID entries in a sector</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;&lt;</span><span class="si">%d</span><span class="s">i&quot;</span> <span class="o">%</span> <span class="n">nent</span>
        <span class="n">trunc_warned</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c">#</span>
        <span class="c"># === build the MSAT ===</span>
        <span class="c">#</span>
        <span class="n">MSAT</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&lt;109i&#39;</span><span class="p">,</span> <span class="n">mem</span><span class="p">[</span><span class="mi">76</span><span class="p">:</span><span class="mi">512</span><span class="p">]))</span>
        <span class="n">SAT_sectors_reqd</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_data_secs</span> <span class="o">+</span> <span class="n">nent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">nent</span>
        <span class="n">expected_MSATX_sectors</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">SAT_sectors_reqd</span> <span class="o">-</span> <span class="mi">109</span> <span class="o">+</span> <span class="n">nent</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span class="n">nent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">actual_MSATX_sectors</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">MSATX_tot_secs</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">MSATX_first_sec_sid</span> <span class="ow">in</span> <span class="p">(</span><span class="n">EOCSID</span><span class="p">,</span> <span class="n">FREESID</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c"># Strictly, if there is no MSAT extension, then MSATX_first_sec_sid</span>
            <span class="c"># should be set to EOCSID ... FREESID and 0 have been met in the wild.</span>
            <span class="k">pass</span> <span class="c"># Presuming no extension</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="n">MSATX_first_sec_sid</span>
            <span class="k">while</span> <span class="n">sid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">EOCSID</span><span class="p">,</span> <span class="n">FREESID</span><span class="p">):</span>
                <span class="c"># Above should be only EOCSID according to MS &amp; OOo docs</span>
                <span class="c"># but Excel doesn&#39;t complain about FREESID. Zero is a valid</span>
                <span class="c"># sector number, not a sentinel.</span>
                <span class="k">if</span> <span class="n">DEBUG</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;MSATX: sid=</span><span class="si">%d</span><span class="s"> (0x</span><span class="si">%08X</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">sid</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sid</span> <span class="o">&gt;=</span> <span class="n">mem_data_secs</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;MSAT extension: accessing sector </span><span class="si">%d</span><span class="s"> but only </span><span class="si">%d</span><span class="s"> in file&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">mem_data_secs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">DEBUG</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">raise</span> <span class="n">CompDocError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">sid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CompDocError</span><span class="p">(</span><span class="s">&quot;MSAT extension: invalid sector id: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">seen</span><span class="p">[</span><span class="n">sid</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="n">CompDocError</span><span class="p">(</span><span class="s">&quot;MSAT corruption: seen[</span><span class="si">%d</span><span class="s">] == </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">seen</span><span class="p">[</span><span class="n">sid</span><span class="p">]))</span>
                <span class="n">seen</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">actual_MSATX_sectors</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">DEBUG</span> <span class="ow">and</span> <span class="n">actual_MSATX_sectors</span> <span class="o">&gt;</span> <span class="n">expected_MSATX_sectors</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;[1]===&gt;&gt;&gt;&quot;</span><span class="p">,</span> <span class="n">mem_data_secs</span><span class="p">,</span> <span class="n">nent</span><span class="p">,</span> <span class="n">SAT_sectors_reqd</span><span class="p">,</span> <span class="n">expected_MSATX_sectors</span><span class="p">,</span> <span class="n">actual_MSATX_sectors</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">+</span> <span class="n">sec_size</span> <span class="o">*</span> <span class="n">sid</span>
                <span class="n">MSAT</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">mem</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">sec_size</span><span class="p">]))</span>
                <span class="n">sid</span> <span class="o">=</span> <span class="n">MSAT</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="c"># last sector id is sid of next sector in the chain</span>
                
        <span class="k">if</span> <span class="n">DEBUG</span> <span class="ow">and</span> <span class="n">actual_MSATX_sectors</span> <span class="o">!=</span> <span class="n">expected_MSATX_sectors</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;[2]===&gt;&gt;&gt;&quot;</span><span class="p">,</span> <span class="n">mem_data_secs</span><span class="p">,</span> <span class="n">nent</span><span class="p">,</span> <span class="n">SAT_sectors_reqd</span><span class="p">,</span> <span class="n">expected_MSATX_sectors</span><span class="p">,</span> <span class="n">actual_MSATX_sectors</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;MSAT: len =&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSAT</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
            <span class="n">dump_list</span><span class="p">(</span><span class="n">MSAT</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">logfile</span><span class="p">)</span>
        <span class="c">#</span>
        <span class="c"># === build the SAT ===</span>
        <span class="c">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SAT</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">actual_SAT_sectors</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dump_again</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">msidx</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MSAT</span><span class="p">)):</span>
            <span class="n">msid</span> <span class="o">=</span> <span class="n">MSAT</span><span class="p">[</span><span class="n">msidx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">msid</span> <span class="ow">in</span> <span class="p">(</span><span class="n">FREESID</span><span class="p">,</span> <span class="n">EOCSID</span><span class="p">):</span>
                <span class="c"># Specification: the MSAT array may be padded with trailing FREESID entries.</span>
                <span class="c"># Toleration: a FREESID or EOCSID entry anywhere in the MSAT array will be ignored.</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">msid</span> <span class="o">&gt;=</span> <span class="n">mem_data_secs</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">trunc_warned</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;WARNING *** File is truncated, or OLE2 MSAT is corrupt!!&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;INFO: Trying to access sector </span><span class="si">%d</span><span class="s"> but only </span><span class="si">%d</span><span class="s"> available&quot;</span> \
                        <span class="o">%</span> <span class="p">(</span><span class="n">msid</span><span class="p">,</span> <span class="n">mem_data_secs</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
                    <span class="n">trunc_warned</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">MSAT</span><span class="p">[</span><span class="n">msidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">EVILSID</span>
                <span class="n">dump_again</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">msid</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CompDocError</span><span class="p">(</span><span class="s">&quot;MSAT: invalid sector id: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">msid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">seen</span><span class="p">[</span><span class="n">msid</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">CompDocError</span><span class="p">(</span><span class="s">&quot;MSAT extension corruption: seen[</span><span class="si">%d</span><span class="s">] == </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msid</span><span class="p">,</span> <span class="n">seen</span><span class="p">[</span><span class="n">msid</span><span class="p">]))</span>
            <span class="n">seen</span><span class="p">[</span><span class="n">msid</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">actual_SAT_sectors</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">DEBUG</span> <span class="ow">and</span> <span class="n">actual_SAT_sectors</span> <span class="o">&gt;</span> <span class="n">SAT_sectors_reqd</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;[3]===&gt;&gt;&gt;&quot;</span><span class="p">,</span> <span class="n">mem_data_secs</span><span class="p">,</span> <span class="n">nent</span><span class="p">,</span> <span class="n">SAT_sectors_reqd</span><span class="p">,</span> <span class="n">expected_MSATX_sectors</span><span class="p">,</span> <span class="n">actual_MSATX_sectors</span><span class="p">,</span> <span class="n">actual_SAT_sectors</span><span class="p">,</span> <span class="n">msid</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">+</span> <span class="n">sec_size</span> <span class="o">*</span> <span class="n">msid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SAT</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">mem</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">sec_size</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;SAT: len =&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SAT</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
            <span class="n">dump_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SAT</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">logfile</span><span class="p">)</span>
            <span class="c"># print &gt;&gt; logfile, &quot;SAT &quot;,</span>
            <span class="c"># for i, s in enumerate(self.SAT):</span>
                <span class="c"># print &gt;&gt; logfile, &quot;entry: %4d offset: %6d, next entry: %4d&quot; % (i, 512 + sec_size * i, s)</span>
                <span class="c"># print &gt;&gt; logfile, &quot;%d:%d &quot; % (i, s),</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">DEBUG</span> <span class="ow">and</span> <span class="n">dump_again</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;MSAT: len =&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSAT</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
            <span class="n">dump_list</span><span class="p">(</span><span class="n">MSAT</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">logfile</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">satx</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">mem_data_secs</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SAT</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SAT</span><span class="p">[</span><span class="n">satx</span><span class="p">]</span> <span class="o">=</span> <span class="n">EVILSID</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;SAT: len =&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SAT</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
            <span class="n">dump_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SAT</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">logfile</span><span class="p">)</span>
        <span class="c">#</span>
        <span class="c"># === build the directory ===</span>
        <span class="c">#</span>
        <span class="n">dbytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stream</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sec_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_first_sec_sid</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&quot;directory&quot;</span><span class="p">,</span> <span class="n">seen_id</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">dirlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">did</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dbytes</span><span class="p">),</span> <span class="mi">128</span><span class="p">):</span>
            <span class="n">did</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">dirlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DirNode</span><span class="p">(</span><span class="n">did</span><span class="p">,</span> <span class="n">dbytes</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span><span class="o">+</span><span class="mi">128</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">logfile</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirlist</span> <span class="o">=</span> <span class="n">dirlist</span>
        <span class="n">_build_family_tree</span><span class="p">(</span><span class="n">dirlist</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dirlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">root_DID</span><span class="p">)</span> <span class="c"># and stand well back ...</span>
        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirlist</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="c">#</span>
        <span class="c"># === get the SSCS ===</span>
        <span class="c">#</span>
        <span class="n">sscs_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">sscs_dir</span><span class="o">.</span><span class="n">etype</span> <span class="o">==</span> <span class="mi">5</span> <span class="c"># root entry</span>
        <span class="k">if</span> <span class="n">sscs_dir</span><span class="o">.</span><span class="n">first_SID</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">sscs_dir</span><span class="o">.</span><span class="n">tot_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># Problem reported by Frank Hoffsuemmer: some software was</span>
            <span class="c"># writing -1 instead of -2 (EOCSID) for the first_SID</span>
            <span class="c"># when the SCCS was empty. Not having EOCSID caused assertion</span>
            <span class="c"># failure in _get_stream.</span>
            <span class="c"># Solution: avoid calling _get_stream in any case when the</span>
            <span class="c"># SCSS appears to be empty.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SSCS</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SSCS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stream</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAT</span><span class="p">,</span> <span class="n">sec_size</span><span class="p">,</span> <span class="n">sscs_dir</span><span class="o">.</span><span class="n">first_SID</span><span class="p">,</span>
                <span class="n">sscs_dir</span><span class="o">.</span><span class="n">tot_size</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;SSCS&quot;</span><span class="p">,</span> <span class="n">seen_id</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="c"># if DEBUG: print &gt;&gt; logfile, &quot;SSCS&quot;, repr(self.SSCS)</span>
        <span class="c">#</span>
        <span class="c"># === build the SSAT ===</span>
        <span class="c">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SSAT</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">SSAT_tot_secs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sscs_dir</span><span class="o">.</span><span class="n">tot_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;WARNING *** OLE2 inconsistency: SSCS size is 0 but SSAT size is non-zero&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sscs_dir</span><span class="o">.</span><span class="n">tot_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="n">SSAT_first_sec_sid</span>
            <span class="n">nsecs</span> <span class="o">=</span> <span class="n">SSAT_tot_secs</span>
            <span class="k">while</span> <span class="n">sid</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nsecs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">seen</span><span class="p">[</span><span class="n">sid</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="n">CompDocError</span><span class="p">(</span><span class="s">&quot;SSAT corruption: seen[</span><span class="si">%d</span><span class="s">] == </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">seen</span><span class="p">[</span><span class="n">sid</span><span class="p">]))</span>
                <span class="n">seen</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
                <span class="n">nsecs</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">start_pos</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">+</span> <span class="n">sid</span> <span class="o">*</span> <span class="n">sec_size</span>
                <span class="n">news</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">mem</span><span class="p">[</span><span class="n">start_pos</span><span class="p">:</span><span class="n">start_pos</span><span class="o">+</span><span class="n">sec_size</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SSAT</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">news</span><span class="p">)</span>
                <span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAT</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&quot;SSAT last sid </span><span class="si">%d</span><span class="s">; remaining sectors </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">nsecs</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">nsecs</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sid</span> <span class="o">==</span> <span class="n">EOCSID</span>
        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;SSAT&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
            <span class="n">dump_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SSAT</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">logfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;seen&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
            <span class="n">dump_list</span><span class="p">(</span><span class="n">seen</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">logfile</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">sat</span><span class="p">,</span> <span class="n">sec_size</span><span class="p">,</span> <span class="n">start_sid</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">seen_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c"># print &gt;&gt; self.logfile, &quot;_get_stream&quot;, base, sec_size, start_sid, size</span>
        <span class="n">sectors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">start_sid</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># nothing to check against</span>
            <span class="k">while</span> <span class="n">s</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">seen_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="n">CompDocError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> corruption: seen[</span><span class="si">%d</span><span class="s">] == </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">[</span><span class="n">s</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">seen_id</span>
                <span class="n">start_pos</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">s</span> <span class="o">*</span> <span class="n">sec_size</span>
                <span class="n">sectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">start_pos</span><span class="p">:</span><span class="n">start_pos</span><span class="o">+</span><span class="n">sec_size</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">sat</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CompDocError</span><span class="p">(</span>
                        <span class="s">&quot;OLE2 stream </span><span class="si">%r</span><span class="s">: sector allocation table invalid entry (</span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                        <span class="p">)</span>
            <span class="k">assert</span> <span class="n">s</span> <span class="o">==</span> <span class="n">EOCSID</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">todo</span> <span class="o">=</span> <span class="n">size</span>
            <span class="k">while</span> <span class="n">s</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">seen_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="n">CompDocError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> corruption: seen[</span><span class="si">%d</span><span class="s">] == </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">[</span><span class="n">s</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">seen_id</span>
                <span class="n">start_pos</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">s</span> <span class="o">*</span> <span class="n">sec_size</span>
                <span class="n">grab</span> <span class="o">=</span> <span class="n">sec_size</span>
                <span class="k">if</span> <span class="n">grab</span> <span class="o">&gt;</span> <span class="n">todo</span><span class="p">:</span>
                    <span class="n">grab</span> <span class="o">=</span> <span class="n">todo</span>
                <span class="n">todo</span> <span class="o">-=</span> <span class="n">grab</span>
                <span class="n">sectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">start_pos</span><span class="p">:</span><span class="n">start_pos</span><span class="o">+</span><span class="n">grab</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">sat</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CompDocError</span><span class="p">(</span>
                        <span class="s">&quot;OLE2 stream </span><span class="si">%r</span><span class="s">: sector allocation table invalid entry (</span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                        <span class="p">)</span>
            <span class="k">assert</span> <span class="n">s</span> <span class="o">==</span> <span class="n">EOCSID</span>
            <span class="k">if</span> <span class="n">todo</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> 
                    <span class="s">&quot;WARNING *** OLE2 stream </span><span class="si">%r</span><span class="s">: expected size </span><span class="si">%d</span><span class="s">, actual size </span><span class="si">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">todo</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sectors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_dir_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">storage_DID</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c"># Return matching DirNode instance, or None</span>
        <span class="n">head</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tail</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirlist</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">dl</span><span class="p">[</span><span class="n">storage_DID</span><span class="p">]</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dl</span><span class="p">[</span><span class="n">child</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">head</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">et</span> <span class="o">=</span> <span class="n">dl</span><span class="p">[</span><span class="n">child</span><span class="p">]</span><span class="o">.</span><span class="n">etype</span>
                <span class="k">if</span> <span class="n">et</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">dl</span><span class="p">[</span><span class="n">child</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">et</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">tail</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">CompDocError</span><span class="p">(</span><span class="s">&quot;Requested component is a &#39;storage&#39;&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir_search</span><span class="p">(</span><span class="n">tail</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
                <span class="n">dl</span><span class="p">[</span><span class="n">child</span><span class="p">]</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">CompDocError</span><span class="p">(</span><span class="s">&quot;Requested stream is not a &#39;user stream&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="c">##</span>
    <span class="c"># Interrogate the compound document&#39;s directory; return the stream as a string if found, otherwise</span>
    <span class="c"># return None.</span>
    <span class="c"># @param qname Name of the desired stream e.g. u&#39;Workbook&#39;. Should be in Unicode or convertible thereto.</span>

<div class="viewcode-block" id="CompDoc.get_named_stream"><a class="viewcode-back" href="../../xlrd.html#xlrd.compdoc.CompDoc.get_named_stream">[docs]</a>    <span class="k">def</span> <span class="nf">get_named_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qname</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir_search</span><span class="p">(</span><span class="n">qname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">tot_size</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_size_std_stream</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stream</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sec_size</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">first_SID</span><span class="p">,</span>
                <span class="n">d</span><span class="o">.</span><span class="n">tot_size</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">qname</span><span class="p">,</span> <span class="n">seen_id</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">DID</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stream</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SSCS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SSAT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_sec_size</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">first_SID</span><span class="p">,</span>
                <span class="n">d</span><span class="o">.</span><span class="n">tot_size</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">qname</span> <span class="o">+</span> <span class="s">&quot; (from SSCS)&quot;</span><span class="p">,</span> <span class="n">seen_id</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Interrogate the compound document&#39;s directory.</span>
    <span class="c"># If the named stream is not found, (None, 0, 0) will be returned.</span>
    <span class="c"># If the named stream is found and is contiguous within the original byte sequence (&quot;mem&quot;)</span>
    <span class="c"># used when the document was opened,</span>
    <span class="c"># then (mem, offset_to_start_of_stream, length_of_stream) is returned.</span>
    <span class="c"># Otherwise a new string is built from the fragments and (new_string, 0, length_of_stream) is returned.</span>
    <span class="c"># @param qname Name of the desired stream e.g. u&#39;Workbook&#39;. Should be in Unicode or convertible thereto.</span>
</div>
<div class="viewcode-block" id="CompDoc.locate_named_stream"><a class="viewcode-back" href="../../xlrd.html#xlrd.compdoc.CompDoc.locate_named_stream">[docs]</a>    <span class="k">def</span> <span class="nf">locate_named_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qname</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir_search</span><span class="p">(</span><span class="n">qname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">tot_size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_data_len</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CompDocError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%r</span><span class="s"> stream length (</span><span class="si">%d</span><span class="s"> bytes) &gt; file data size (</span><span class="si">%d</span><span class="s"> bytes)&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">qname</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">tot_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_data_len</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">tot_size</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_size_std_stream</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locate_stream</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sec_size</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">first_SID</span><span class="p">,</span> 
                <span class="n">d</span><span class="o">.</span><span class="n">tot_size</span><span class="p">,</span> <span class="n">qname</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">DID</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">seen&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="p">)</span>
                <span class="n">dump_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_stream</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">SSCS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SSAT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_sec_size</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">first_SID</span><span class="p">,</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">tot_size</span><span class="p">,</span> <span class="n">qname</span> <span class="o">+</span> <span class="s">&quot; (from SSCS)&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">d</span><span class="o">.</span><span class="n">tot_size</span>
                <span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_locate_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">sat</span><span class="p">,</span> <span class="n">sec_size</span><span class="p">,</span> <span class="n">start_sid</span><span class="p">,</span> <span class="n">expected_stream_size</span><span class="p">,</span> <span class="n">qname</span><span class="p">,</span> <span class="n">seen_id</span><span class="p">):</span>
        <span class="c"># print &gt;&gt; self.logfile, &quot;_locate_stream&quot;, base, sec_size, start_sid, expected_stream_size</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">start_sid</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CompDocError</span><span class="p">(</span><span class="s">&quot;_locate_stream: start_sid (</span><span class="si">%d</span><span class="s">) is -ve&quot;</span> <span class="o">%</span> <span class="n">start_sid</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="o">-</span><span class="mi">99</span> <span class="c"># dummy previous SID</span>
        <span class="n">start_pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>
        <span class="n">end_pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">8888</span>
        <span class="n">slices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tot_found</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">found_limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">expected_stream_size</span> <span class="o">+</span> <span class="n">sec_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">sec_size</span>
        <span class="k">while</span> <span class="n">s</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;_locate_stream(</span><span class="si">%s</span><span class="s">): seen&quot;</span> <span class="o">%</span> <span class="n">qname</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="p">);</span> <span class="n">dump_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">CompDocError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> corruption: seen[</span><span class="si">%d</span><span class="s">] == </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qname</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">[</span><span class="n">s</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">seen_id</span>
            <span class="n">tot_found</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">tot_found</span> <span class="o">&gt;</span> <span class="n">found_limit</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CompDocError</span><span class="p">(</span>
                    <span class="s">&quot;</span><span class="si">%s</span><span class="s">: size exceeds expected </span><span class="si">%d</span><span class="s"> bytes; corrupt?&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">qname</span><span class="p">,</span> <span class="n">found_limit</span> <span class="o">*</span> <span class="n">sec_size</span><span class="p">)</span>
                    <span class="p">)</span> <span class="c"># Note: expected size rounded up to higher sector</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="c"># contiguous sectors</span>
                <span class="n">end_pos</span> <span class="o">+=</span> <span class="n">sec_size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># start new slice</span>
                <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c"># not first time</span>
                    <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">))</span>
                <span class="n">start_pos</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">s</span> <span class="o">*</span> <span class="n">sec_size</span>
                <span class="n">end_pos</span> <span class="o">=</span> <span class="n">start_pos</span> <span class="o">+</span> <span class="n">sec_size</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">s</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">sat</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">s</span> <span class="o">==</span> <span class="n">EOCSID</span>
        <span class="k">assert</span> <span class="n">tot_found</span> <span class="o">==</span> <span class="n">found_limit</span>
        <span class="c"># print &gt;&gt; self.logfile, &quot;_locate_stream(%s): seen&quot; % qname; dump_list(self.seen, 20, self.logfile)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">slices</span><span class="p">:</span>
            <span class="c"># The stream is contiguous ... just what we like!</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">start_pos</span><span class="p">,</span> <span class="n">expected_stream_size</span><span class="p">)</span>
        <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">))</span>
        <span class="c"># print &gt;&gt; self.logfile, &quot;+++&gt;&gt;&gt; %d fragments&quot; % len(slices)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">mem</span><span class="p">[</span><span class="n">start_pos</span><span class="p">:</span><span class="n">end_pos</span><span class="p">]</span> <span class="k">for</span> <span class="n">start_pos</span><span class="p">,</span> <span class="n">end_pos</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">expected_stream_size</span><span class="p">)</span>

<span class="c"># ==========================================================================================</span></div>
<div class="viewcode-block" id="x_dump_line"><a class="viewcode-back" href="../../xlrd.html#xlrd.compdoc.x_dump_line">[docs]</a><span class="k">def</span> <span class="nf">x_dump_line</span><span class="p">(</span><span class="n">alist</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">dpos</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%5d%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dpos</span><span class="p">,</span> <span class="s">&quot; =&quot;</span><span class="p">[</span><span class="n">equal</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">alist</span><span class="p">[</span><span class="n">dpos</span><span class="p">:</span><span class="n">dpos</span> <span class="o">+</span> <span class="n">stride</span><span class="p">]:</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="dump_list"><a class="viewcode-back" href="../../xlrd.html#xlrd.compdoc.dump_list">[docs]</a><span class="k">def</span> <span class="nf">dump_list</span><span class="p">(</span><span class="n">alist</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_dump_line</span><span class="p">(</span><span class="n">dpos</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%5d%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dpos</span><span class="p">,</span> <span class="s">&quot; =&quot;</span><span class="p">[</span><span class="n">equal</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">alist</span><span class="p">[</span><span class="n">dpos</span><span class="p">:</span><span class="n">dpos</span> <span class="o">+</span> <span class="n">stride</span><span class="p">]:</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">oldpos</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">alist</span><span class="p">),</span> <span class="n">stride</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">oldpos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">_dump_line</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">oldpos</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="k">elif</span> <span class="n">alist</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span><span class="o">+</span><span class="n">stride</span><span class="p">]</span> <span class="o">!=</span> <span class="n">alist</span><span class="p">[</span><span class="n">oldpos</span><span class="p">:</span><span class="n">oldpos</span><span class="o">+</span><span class="n">stride</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">oldpos</span> <span class="o">&gt;</span> <span class="n">stride</span><span class="p">:</span>
                <span class="n">_dump_line</span><span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="n">stride</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">_dump_line</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">oldpos</span> <span class="o">=</span> <span class="n">pos</span>
    <span class="k">if</span> <span class="n">oldpos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">pos</span> <span class="o">!=</span> <span class="n">oldpos</span><span class="p">:</span>
        <span class="n">_dump_line</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  <li><a href="../xlrd.html">xlrd</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.6</a>
      
    </div>

    

    
  </body>
</html>