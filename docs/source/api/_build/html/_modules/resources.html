<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>resources &mdash; app  documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="app  documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for resources</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/python2.7</span>
<span class="c"># Copyright 2010 Google Inc.</span>
<span class="c">#</span>
<span class="c"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c"># you may not use this file except in compliance with the License.</span>
<span class="c"># You may obtain a copy of the License at</span>
<span class="c">#</span>
<span class="c">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">#</span>
<span class="c"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c"># See the License for the specific language governing permissions and</span>
<span class="c"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;Resources are blobs in the datastore that can contain pages of HTML,</span>
<span class="sd">stylesheets, images, or templates.  A Resource is just like a small file</span>
<span class="sd">except for a few additional features:</span>
<span class="sd">    1. Resources are grouped under ResourceBundles.</span>
<span class="sd">    2. Resources can be fetched from the datastore or from files on disk.</span>
<span class="sd">    3. We can store localized variants of a resource and select one.</span>
<span class="sd">    4. We support compiling and rendering a resource as a Django template.</span>
<span class="sd">    5. We cache the fetched, compiled, or rendered result in RAM.</span>
<span class="sd">Similar to App Engine&#39;s app versions, there is a concept of an &quot;active bundle&quot;</span>
<span class="sd">from which resources are obtained.  Previewing or releasing a new set of</span>
<span class="sd">resources is a matter of setting the active bundle.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">django_setup</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">utils</span>

<span class="kn">import</span> <span class="nn">django.template</span>

<span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">webapp</span>


<span class="c"># Requests for files and pages pass through three stages:</span>
<span class="c">#   1. get_rendered(): decides whether to serve plain data or render a Template</span>
<span class="c">#   2. get_localized(): selects the localized variant of a Resource</span>
<span class="c">#   3. Resource.get(): gets a Resource from the datastore or from a file</span>
<span class="c">#</span>
<span class="c"># When a request is served by a dynamic handler, the handler prepares some</span>
<span class="c"># template variables and then renders the template using the same four stages.</span>
<span class="c">#</span>
<span class="c"># Suppose that a static image file &#39;/global/logo.jpg&#39; is requested, the current</span>
<span class="c"># language is &#39;ru&#39;, and there is a Resource entity with key name &#39;logo.jpg&#39; in</span>
<span class="c"># ResourceBundle &#39;1&#39;.  The expected sequence of calls is as follows:</span>
<span class="c">#</span>
<span class="c"># request for static image, action=&#39;logo.jpg&#39;</span>
<span class="c"># &gt; get_rendered(&#39;logo.jpg&#39;, &#39;ru&#39;)</span>
<span class="c">#   &gt; get_localized(&#39;logo.jpg&#39;, &#39;ru&#39;)</span>
<span class="c">#     &gt; Resource.get(&#39;logo.jpg:ru&#39;, B)  # B is &lt;ResourceBundle &#39;1&#39;&gt;</span>
<span class="c">#       &gt; Resource.get_by_key_name(&#39;logo.jpg:ru&#39;, B) -&gt; None</span>
<span class="c">#       &gt; Resource.load_from_file(&#39;logo.jpg:ru&#39;) -&gt; None</span>
<span class="c">#     &gt; Resource.get(&#39;logo.jpg&#39;, B)</span>
<span class="c">#       &gt; Resource.get_by_key_name(&#39;logo.jpg&#39;, B) -&gt; R1</span>
<span class="c">#     &gt; LOCALIZED_CACHE.put((&#39;logo.jpg&#39;, &#39;ru&#39;), R1)</span>
<span class="c">#   &gt; RENDERED_CACHE.put((&#39;logo.jpg&#39;, &#39;ru&#39;, None), R1.content)</span>
<span class="c"># &gt; self.response.out.write(R1.content)</span>
<span class="c">#</span>
<span class="c"># Suppose that a static page &#39;/global/faq.html&#39; is requested.  Assume there is</span>
<span class="c"># a localized &#39;faq.html.template:ru&#39; resource in Russian and a non-localized</span>
<span class="c"># template file at &#39;resources/base.template&#39;, and all the caches are initially</span>
<span class="c"># empty.  Due to the settings in django_setup.py, resources.TemplateLoader will</span>
<span class="c"># handle template loading.  The expected sequence of calls is as follows:</span>
<span class="c">#</span>
<span class="c"># request for static page, action=&#39;faq.html&#39;</span>
<span class="c"># &gt; get_rendered(&#39;faq.html&#39;, &#39;ru&#39;)</span>
<span class="c">#   &gt; get_localized(&#39;faq.html&#39;, &#39;ru&#39;)</span>
<span class="c">#     &gt; Resource.get(&#39;faq.html:ru&#39;) -&gt; None</span>
<span class="c">#     &gt; Resource.get(&#39;faq.html&#39;) -&gt; None</span>
<span class="c">#   &gt; get_localized(&#39;faq.html.template&#39;, &#39;ru&#39;)</span>
<span class="c">#     &gt; Resource.get(&#39;faq.html.template:ru&#39;)</span>
<span class="c">#       &gt; Resource.get_by_key_name(&#39;faq.html.template:ru&#39;, B) -&gt; R2</span>
<span class="c">#     &gt; LOCALIZED_CACHE.put((&#39;faq.html.template&#39;, &#39;ru&#39;), R2)</span>
<span class="c">#   &gt; R2.get_template() -&gt; T2  # compile the template</span>
<span class="c">#   &gt; T2.render(vars)  # T2 extends &quot;base.html.template&quot;, so:</span>
<span class="c">#     &gt; TemplateLoader.load_template(&#39;base.html.template&#39;)</span>
<span class="c">#       &gt; get_localized(&#39;base.html.template&#39;, &#39;ru&#39;)</span>
<span class="c">#         &gt; Resource.get(&#39;base.html.template:ru&#39;)</span>
<span class="c">#           &gt; Resource.get_by_key_name(&#39;base.html.template:ru&#39;, B) -&gt; None</span>
<span class="c">#           &gt; Resource.load_from_file(&#39;base.html.template:ru&#39;) -&gt; None</span>
<span class="c">#         &gt; Resource.get(&#39;base.html.template&#39;)</span>
<span class="c">#           &gt; Resource.get_by_key_name(&#39;base.html.template&#39;, B) -&gt; None</span>
<span class="c">#           &gt; Resource.load_from_file(&#39;base.html.template&#39;) -&gt; R3</span>
<span class="c">#         &gt; LOCALIZED_CACHE.put((&#39;base.html.template&#39;, &#39;ru&#39;), R3)</span>
<span class="c">#       &gt; R3.get_template() -&gt; T3  # compile the template</span>
<span class="c">#     &gt; return rendered_string</span>
<span class="c">#   &gt; RENDERED_CACHE.put((&#39;faq.html&#39;, &#39;ru&#39;, None), rendered_string)</span>
<span class="c"># &gt; self.response.out.write(rendered_string)</span>
<span class="c">#</span>
<span class="c"># Suppose the dynamic page &#39;/&lt;repo&gt;/view&#39; is now requested.  Assume that R3</span>
<span class="c"># is still cached from the above request.  The expected sequence of calls is:</span>
<span class="c"># </span>
<span class="c"># request for dynamic page, action=&#39;view&#39;, with an &#39;id&#39; query parameter</span>
<span class="c"># &gt; view.Handler.get()</span>
<span class="c">#   &gt; model.Person.get_by_key_name(person_record_id)</span>
<span class="c">#   &gt; BaseHandler.render(&#39;view.html&#39;, given_name=..., ...)</span>
<span class="c">#     &gt; get_rendered(&#39;view.html&#39;, &#39;ru&#39;, ..., given_name=..., ...)</span>
<span class="c">#       &gt; get_localized(&#39;view.html&#39;, &#39;ru&#39;) -&gt; None</span>
<span class="c">#       &gt; get_localized(&#39;view.html.template&#39;, &#39;ru&#39;)</span>
<span class="c">#         &gt; Resource.get(&#39;view.html.template:ru&#39;, B)</span>
<span class="c">#           &gt; Resource.get_by_key_name(&#39;view.html.template:ru&#39;, B) -&gt; None</span>
<span class="c">#           &gt; Resource.load_from_file(&#39;view.html.template:ru&#39;) -&gt; None</span>
<span class="c">#         &gt; Resource.get(&#39;view.html.template&#39;)</span>
<span class="c">#           &gt; Resource.get_by_key_name(&#39;view.html.template&#39;, B) -&gt; None</span>
<span class="c">#           &gt; Resource.load_from_file(&#39;view.html.template&#39;) -&gt; R4</span>
<span class="c">#         &gt; LOCALIZED_CACHE.put((&#39;view.template&#39;, &#39;ru&#39;), R4)</span>
<span class="c">#       &gt; R4.get_template() -&gt; T4  # compiled the template</span>
<span class="c">#       &gt; T4.render(given_name=..., ...)  # T4 extends &quot;base.html.template&quot;, so:</span>
<span class="c">#         &gt; TemplateLoader.load_template(&#39;base.html.template&#39;)</span>
<span class="c">#           &gt; get_localized(&#39;base.html.template&#39;, &#39;ru&#39;)</span>
<span class="c">#             &gt; LOCALIZED_CACHE.get((&#39;base.html.template&#39;, &#39;ru&#39;)) -&gt; R3</span>
<span class="c">#           &gt; R3.get_template() -&gt; T3  # gets previously compiled R3.template</span>
<span class="c">#         &gt; return rendered_string</span>
<span class="c">#       &gt; return rendered_string  # don&#39;t cache</span>
<span class="c">#     &gt; self.response.out.write(rendered_string)</span>


<div class="viewcode-block" id="RamCache"><a class="viewcode-back" href="../resources.html#resources.RamCache">[docs]</a><span class="k">class</span> <span class="nc">RamCache</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="RamCache.clear"><a class="viewcode-back" href="../resources.html#resources.RamCache.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="RamCache.put"><a class="viewcode-back" href="../resources.html#resources.RamCache.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">ttl_seconds</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ttl_seconds</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">expiry</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ttl_seconds</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">expiry</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RamCache.get"><a class="viewcode-back" href="../resources.html#resources.RamCache.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">expiry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_utcnow</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">expiry</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>

</div></div>
<div class="viewcode-block" id="ResourceBundle"><a class="viewcode-back" href="../resources.html#resources.ResourceBundle">[docs]</a><span class="k">class</span> <span class="nc">ResourceBundle</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parent entity for a set of resources.  The key_name is a bundle name</span>
<span class="sd">    arbitrarily chosen by the admin user who stored the resources.&quot;&quot;&quot;</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">DateTimeProperty</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c"># for bookkeeping</span>

<div class="viewcode-block" id="ResourceBundle.list_resources"><a class="viewcode-back" href="../resources.html#resources.ResourceBundle.list_resources">[docs]</a>    <span class="k">def</span> <span class="nf">list_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of the names of resources in this bundle.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Resource</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">keys_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">ancestor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">query</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="Resource"><a class="viewcode-back" href="../resources.html#resources.Resource">[docs]</a><span class="k">class</span> <span class="nc">Resource</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Resources are blobs in the datastore that can contain pages of HTML,</span>
<span class="sd">    stylesheets, images, or templates.  A Resource is just like a small file</span>
<span class="sd">    except for a few additional features:</span>
<span class="sd">        1. Resources are grouped under ResourceBundles.</span>
<span class="sd">        2. Resources can be fetched from the datastore or from files on disk.</span>
<span class="sd">        3. We can store localized variants of a resource and select one.</span>
<span class="sd">        4. We support compiling and rendering a resource as a Django template.</span>
<span class="sd">        5. We cache the fetched, compiled, or rendered result in RAM.</span>
<span class="sd">    The key_name is a resource_name or resource_name + &#39;:&#39; + language_code.</span>
<span class="sd">    All Resource entities should be children of a ResourceBundle.&quot;&quot;&quot;</span>
    <span class="n">cache_seconds</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">FloatProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c"># cache TTL of resource</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">BlobProperty</span><span class="p">()</span>  <span class="c"># binary data or UTF8-encoded template text</span>
    <span class="n">last_modified</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">DateTimeProperty</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c"># for bookkeeping</span>

    <span class="n">RESOURCE_DIR</span> <span class="o">=</span> <span class="s">&#39;resources&#39;</span>  <span class="c"># directory containing resource files</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Resource.list_files"><a class="viewcode-back" href="../resources.html#resources.Resource.list_files">[docs]</a>    <span class="k">def</span> <span class="nf">list_files</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of the files in the resource directory.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">Resource</span><span class="o">.</span><span class="n">RESOURCE_DIR</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Resource.load_from_file"><a class="viewcode-back" href="../resources.html#resources.Resource.load_from_file">[docs]</a>    <span class="k">def</span> <span class="nf">load_from_file</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a Resource from a file, or returns None if no such file.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">Resource</span><span class="o">.</span><span class="n">RESOURCE_DIR</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Resource</span><span class="p">(</span><span class="n">key_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="nb">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Resource.get"><a class="viewcode-back" href="../resources.html#resources.Resource.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bundle_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetches a resource, first looking in the datastore, then falling</span>
<span class="sd">        back to a file on disk.  Returns None if neither is found.&quot;&quot;&quot;</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">bundle_name</span> <span class="ow">and</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="s">&#39;ResourceBundle&#39;</span><span class="p">,</span> <span class="n">bundle_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">parent</span> <span class="ow">and</span> <span class="n">Resource</span><span class="o">.</span><span class="n">get_by_key_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">Resource</span><span class="o">.</span><span class="n">load_from_file</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Resource.get_template"><a class="viewcode-back" href="../resources.html#resources.Resource.get_template">[docs]</a>    <span class="k">def</span> <span class="nf">get_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compiles the content of this resource into a Template object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;template&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">django</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s">&#39;Resource&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c"># Exception here is silently ignored otherwise.</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s">&#39;Error loading template </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span>
                    <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">django</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span>
                    <span class="s">&#39;Internal Server Error&#39;</span><span class="p">,</span>
                    <span class="s">&#39;Resource&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span>

</div></div>
<span class="n">LOCALIZED_CACHE</span> <span class="o">=</span> <span class="n">RamCache</span><span class="p">()</span>  <span class="c"># contains Resource objects</span>
<span class="n">RENDERED_CACHE</span> <span class="o">=</span> <span class="n">RamCache</span><span class="p">()</span>  <span class="c"># contains strings of rendered content</span>

<div class="viewcode-block" id="clear_caches"><a class="viewcode-back" href="../resources.html#resources.clear_caches">[docs]</a><span class="k">def</span> <span class="nf">clear_caches</span><span class="p">():</span>
    <span class="n">LOCALIZED_CACHE</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">RENDERED_CACHE</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</div>
<span class="n">active_bundle_name</span> <span class="o">=</span> <span class="s">&#39;1&#39;</span>

<div class="viewcode-block" id="set_active_bundle_name"><a class="viewcode-back" href="../resources.html#resources.set_active_bundle_name">[docs]</a><span class="k">def</span> <span class="nf">set_active_bundle_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets the currently active bundle.  Unfortunately, this is a global</span>
<span class="sd">    setting because the Django template loader (django_setup.TemplateLoader)</span>
<span class="sd">    is also a global setting, and so far we don&#39;t know a way to pass the bundle</span>
<span class="sd">    name from get_rendered to the template loader.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">active_bundle_name</span>
    <span class="n">active_bundle_name</span> <span class="o">=</span> <span class="n">name</span>
</div>
<div class="viewcode-block" id="get_localized"><a class="viewcode-back" href="../resources.html#resources.get_localized">[docs]</a><span class="k">def</span> <span class="nf">get_localized</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">bundle_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the localized (or if none, generic) variant of a Resource from the</span>
<span class="sd">    cache, the datastore, or a file.  Returns None if no match is found.&quot;&quot;&quot;</span>
    <span class="n">bundle_name</span> <span class="o">=</span> <span class="n">bundle_name</span> <span class="ow">or</span> <span class="n">active_bundle_name</span>
    <span class="n">cache_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">bundle_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="n">LOCALIZED_CACHE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">resource</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lang</span><span class="p">:</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="n">Resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="n">lang</span><span class="p">,</span> <span class="n">bundle_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resource</span><span class="p">:</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="n">Resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bundle_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resource</span><span class="p">:</span>
            <span class="n">LOCALIZED_CACHE</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">resource</span><span class="o">.</span><span class="n">cache_seconds</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resource</span>
</div>
<div class="viewcode-block" id="get_rendered"><a class="viewcode-back" href="../resources.html#resources.get_rendered">[docs]</a><span class="k">def</span> <span class="nf">get_rendered</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">extra_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">get_vars</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{},</span> <span class="n">cache_seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bundle_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the rendered content of a Resource from the cache or the datastore.</span>
<span class="sd">    If name is &#39;foo.html&#39;, this looks for a Resource named &#39;foo.html&#39; to serve</span>
<span class="sd">    as a plain file, then a Resource named &#39;foo.html.template&#39; to render as a</span>
<span class="sd">    template.  Returns None if nothing suitable is found.  When rendering a</span>
<span class="sd">    template, this calls get_vars() to obtain a dictionary of template</span>
<span class="sd">    variables.  The cache is keyed on bundle_name, name, lang, and extra_key;</span>
<span class="sd">    use extra_key to capture dependencies on template variables).&quot;&quot;&quot;</span>
    <span class="n">bundle_name</span> <span class="o">=</span> <span class="n">bundle_name</span> <span class="ow">or</span> <span class="n">active_bundle_name</span>
    <span class="n">cache_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">bundle_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">extra_key</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">RENDERED_CACHE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">get_localized</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">bundle_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resource</span><span class="p">:</span>  <span class="c"># a plain file is available</span>
            <span class="k">return</span> <span class="n">resource</span><span class="o">.</span><span class="n">content</span>  <span class="c"># already cached, no need to cache again</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">get_localized</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39;.template&#39;</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">bundle_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resource</span><span class="p">:</span>  <span class="c"># a template is available</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">render_in_lang</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">get_template</span><span class="p">(),</span> <span class="n">lang</span><span class="p">,</span> <span class="n">get_vars</span><span class="p">())</span>
            <span class="n">RENDERED_CACHE</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">cache_seconds</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">content</span>
</div>
<div class="viewcode-block" id="render_in_lang"><a class="viewcode-back" href="../resources.html#resources.render_in_lang">[docs]</a><span class="k">def</span> <span class="nf">render_in_lang</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="nb">vars</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Renders a template in a given language.  We use this to ensure that</span>
<span class="sd">    Django&#39;s idea of the current language matches our cache keys.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">django.utils.translation</span>
    <span class="n">original_lang</span> <span class="o">=</span> <span class="n">django</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">get_language</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">django</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">django</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="nb">vars</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">django</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="n">original_lang</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.6</a>
      
    </div>

    

    
  </body>
</html>