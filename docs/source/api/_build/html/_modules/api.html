<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>api &mdash; app  documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="app  documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for api</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/python2.7</span>
<span class="c"># Copyright 2010 Google Inc.</span>
<span class="c">#</span>
<span class="c"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c"># you may not use this file except in compliance with the License.</span>
<span class="c"># You may obtain a copy of the License at</span>
<span class="c">#</span>
<span class="c">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">#</span>
<span class="c"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c"># See the License for the specific language governing permissions and</span>
<span class="c"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;Basic API for reading/writing small numbers of records.&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;kpy@google.com (Ka-Ping Yee)&#39;</span>

<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">StringIO</span>
<span class="kn">import</span> <span class="nn">xml.dom.minidom</span>

<span class="kn">import</span> <span class="nn">django.utils.html</span>
<span class="kn">from</span> <span class="nn">google.appengine</span> <span class="kn">import</span> <span class="n">runtime</span>
<span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">images</span>

<span class="kn">import</span> <span class="nn">config</span>
<span class="kn">import</span> <span class="nn">external_search</span>
<span class="kn">import</span> <span class="nn">full_text_search</span>
<span class="kn">import</span> <span class="nn">importer</span>
<span class="kn">import</span> <span class="nn">indexing</span>
<span class="kn">import</span> <span class="nn">model</span>
<span class="kn">import</span> <span class="nn">pfif</span>
<span class="kn">import</span> <span class="nn">simplejson</span>
<span class="kn">import</span> <span class="nn">subscribe</span>
<span class="kn">import</span> <span class="nn">utils</span>
<span class="kn">import</span> <span class="nn">xlrd</span>
<span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="n">Person</span><span class="p">,</span> <span class="n">Note</span><span class="p">,</span> <span class="n">ApiActionLog</span>
<span class="kn">from</span> <span class="nn">text_query</span> <span class="kn">import</span> <span class="n">TextQuery</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">Struct</span>
<span class="kn">from</span> <span class="nn">photo</span> <span class="kn">import</span> <span class="n">create_photo</span><span class="p">,</span> <span class="n">PhotoError</span>


<span class="n">HARD_MAX_RESULTS</span> <span class="o">=</span> <span class="mi">200</span>  <span class="c"># Clients can ask for more, but won&#39;t get more.</span>
<span class="n">PHOTO_UPLOAD_MAX_SIZE</span> <span class="o">=</span> <span class="mi">10485760</span> <span class="c"># Currently 10MB is the maximum upload size</span>

<div class="viewcode-block" id="InputFileError"><a class="viewcode-back" href="../api.html#api.InputFileError">[docs]</a><span class="k">class</span> <span class="nc">InputFileError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="get_requested_formats"><a class="viewcode-back" href="../api.html#api.get_requested_formats">[docs]</a><span class="k">def</span> <span class="nf">get_requested_formats</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a list of requested formats.</span>
<span class="sd">    The possible values are &#39;persons&#39; and &#39;notes&#39;.&quot;&quot;&quot;</span>
    <span class="n">format</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">format</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;persons&#39;</span><span class="p">,</span> <span class="s">&#39;notes&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">format</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="s">&#39;persons&#39;</span><span class="p">,</span> <span class="s">&#39;notes&#39;</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="complete_record_ids"><a class="viewcode-back" href="../api.html#api.complete_record_ids">[docs]</a><span class="k">def</span> <span class="nf">complete_record_ids</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensures that a record&#39;s record_id fields are prefixed with a domain.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">and</span> <span class="s">&#39;/&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">id</span><span class="p">:</span>
            <span class="n">record</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
    <span class="n">complete</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="s">&#39;person_record_id&#39;</span><span class="p">)</span>
    <span class="n">complete</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="s">&#39;note_record_id&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">record</span>

</div>
<div class="viewcode-block" id="get_tag_params"><a class="viewcode-back" href="../api.html#api.get_tag_params">[docs]</a><span class="k">def</span> <span class="nf">get_tag_params</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return HTML tag parameters used in import.html.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">&#39;begin_notes_template_link&#39;</span><span class="p">:</span>
            <span class="s">&#39;&lt;a href=&quot;</span><span class="si">%s</span><span class="s">/notes-template.xlsx&quot;&gt;&#39;</span> <span class="o">%</span>
                <span class="n">django</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">global_url</span><span class="p">),</span>
        <span class="s">&#39;end_notes_template_link&#39;</span><span class="p">:</span>
            <span class="s">&#39;&lt;/a&gt;&#39;</span><span class="p">,</span>
        <span class="s">&#39;begin_sample_anchor_tag&#39;</span><span class="p">:</span>
            <span class="s">&#39;&lt;a href=&quot;</span><span class="si">%s</span><span class="s">/sample-import.csv&quot; target=&quot;_blank&quot;&gt;&#39;</span> <span class="o">%</span>
                <span class="n">django</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">global_url</span><span class="p">),</span>
        <span class="s">&#39;end_sample_anchor_tag&#39;</span><span class="p">:</span>
            <span class="s">&#39;&lt;/a&gt;&#39;</span><span class="p">,</span>
        <span class="s">&#39;begin_document_anchor_tag&#39;</span><span class="p">:</span>
            <span class="s">&#39;&lt;a href=&#39;</span>
            <span class="s">&#39;&quot;https://github.com/google/personfinder/wiki/ImportCSV&quot; &#39;</span>
            <span class="s">&#39;target=&quot;_blank&quot;&gt;&#39;</span><span class="p">,</span>
        <span class="s">&#39;end_document_anchor_tag&#39;</span><span class="p">:</span>
            <span class="s">&#39;&lt;/a&gt;&#39;</span><span class="p">,</span>
    <span class="p">}</span>

</div>
<div class="viewcode-block" id="generate_note_record_ids"><a class="viewcode-back" href="../api.html#api.generate_note_record_ids">[docs]</a><span class="k">def</span> <span class="nf">generate_note_record_ids</span><span class="p">(</span><span class="n">records</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;note_record_id&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">record</span><span class="p">[</span><span class="s">&#39;note_record_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">UniqueId</span><span class="o">.</span><span class="n">create_id</span><span class="p">())</span>
        <span class="k">yield</span> <span class="n">record</span>

</div>
<div class="viewcode-block" id="convert_time"><a class="viewcode-back" href="../api.html#api.convert_time">[docs]</a><span class="k">def</span> <span class="nf">convert_time</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a textual date and time into an RFC 3339 UTC timestamp.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">DATETIME_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>  <span class="c"># don&#39;t apply offset</span>
        <span class="k">return</span> <span class="n">text</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;(\d\d\d\d)[/-](\d+)[/-](\d+) *(\d+):(\d+)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">())</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">((</span><span class="n">y</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">-</span> <span class="n">offset</span><span class="o">*</span><span class="mi">3600</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">format_utc_timestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span>  <span class="c"># keep the original text so it shows up in the error message</span>

</div>
<div class="viewcode-block" id="convert_time_fields"><a class="viewcode-back" href="../api.html#api.convert_time_fields">[docs]</a><span class="k">def</span> <span class="nf">convert_time_fields</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">default_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Filters CSV rows, converting time fields to RFC 3339 UTC times.</span>

<span class="sd">    The first row that contains &quot;person_record_id&quot; is assumed to be the header</span>
<span class="sd">    row containing field names.  Preceding rows are treated as a preamble.</span>

<span class="sd">    If the text &quot;time_zone_offset&quot; is found in the preamble section, the cell</span>
<span class="sd">    immediately below it is treated as a time zone offset from UTC in hours.</span>
<span class="sd">    Otherwise default_offset is used as the time zone offset.</span>

<span class="sd">    Rows below the header row are returned as dictionaries (as csv.DictReader</span>
<span class="sd">    would), except that any &quot;*_date&quot; fields are parsed as local times,</span>
<span class="sd">    converted to UTC according to the specified offset, and reformatted</span>
<span class="sd">    as RFC 3339 UTC times.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">field_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">time_fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">setting_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">default_offset</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field_names</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">field_names</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">time_fields</span><span class="p">:</span>
                <span class="n">record</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_time</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">offset</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">record</span>

        <span class="k">elif</span> <span class="s">&#39;person_record_id&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
            <span class="n">field_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span>
            <span class="n">time_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">row</span> <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;_date&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="s">&#39;time_zone_offset&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;time_zone_offset&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InputFileError</span><span class="p">(</span><span class="s">&#39;invalid time_zone_offset value&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">setting_names</span><span class="p">,</span> <span class="n">row</span><span class="p">)))</span>
            <span class="n">setting_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="convert_xsl_to_csv"><a class="viewcode-back" href="../api.html#api.convert_xsl_to_csv">[docs]</a><span class="k">def</span> <span class="nf">convert_xsl_to_csv</span><span class="p">(</span><span class="n">contents</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts data in xsl (or xslx) format to CSV.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">book</span> <span class="o">=</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">open_workbook</span><span class="p">(</span><span class="n">file_contents</span><span class="o">=</span><span class="n">contents</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">XLRDError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;The encoding of the file is unknown.&#39;</span>
    <span class="k">if</span> <span class="n">book</span><span class="o">.</span><span class="n">nsheets</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;The uploaded file contains no sheets.&#39;</span>
    <span class="n">sheet</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">sheet_by_index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">nrows</span><span class="p">):</span>
        <span class="n">table_row</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">ncols</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">cell_value</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
            <span class="n">cell_type</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_type</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cell_type</span> <span class="o">==</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">XL_CELL_TEXT</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">cell_value</span>
            <span class="k">elif</span> <span class="n">cell_type</span> <span class="o">==</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">XL_CELL_NUMBER</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">cell_value</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">cell_type</span> <span class="o">==</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">XL_CELL_BOOLEAN</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s">&#39;true&#39;</span> <span class="k">if</span> <span class="n">cell_value</span> <span class="k">else</span> <span class="s">&#39;false&#39;</span>
            <span class="k">elif</span> <span class="n">cell_type</span> <span class="o">==</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">XL_CELL_DATE</span><span class="p">:</span>
                <span class="c"># TODO(ryok): support date type.</span>
                <span class="k">pass</span>
            <span class="n">table_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table_row</span><span class="p">)</span>

    <span class="n">csv_output</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csv_output</span><span class="p">)</span>
    <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">csv_output</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="bp">None</span>

</div>
<div class="viewcode-block" id="Import"><a class="viewcode-back" href="../api.html#api.Import">[docs]</a><span class="k">class</span> <span class="nc">Import</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="n">https_required</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="Import.get"><a class="viewcode-back" href="../api.html#api.Import.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;import.html&#39;</span><span class="p">,</span>
                    <span class="n">formats</span><span class="o">=</span><span class="n">get_requested_formats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
                    <span class="o">**</span><span class="n">get_tag_params</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Import.post"><a class="viewcode-back" href="../api.html#api.Import.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">domain_write_permission</span><span class="p">):</span>
            <span class="c"># TODO(ryok): i18n</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&#39;Missing or invalid authorization key.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;content&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&#39;Please specify at least one CSV file.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c"># Handle Excel sheets.</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;content&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;\.xlsx?$&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
            <span class="n">content</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">convert_xsl_to_csv</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>  <span class="c"># handles \r, \n, or \r\n</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;format&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;notes&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">import_notes</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">import_persons</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InputFileError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&#39;Problem in the uploaded file: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">runtime</span><span class="o">.</span><span class="n">DeadlineExceededError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span>
                <span class="s">&#39;Sorry, the uploaded file is too large. Try splitting it into &#39;</span>
                <span class="s">&#39;smaller files (keeping the header rows in each file) and &#39;</span>
                <span class="s">&#39;uploading each part separately.&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Import.import_notes"><a class="viewcode-back" href="../api.html#api.Import.import_notes">[docs]</a>    <span class="k">def</span> <span class="nf">import_notes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="n">source_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">domain_write_permission</span>
        <span class="n">records</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">utf8_decoder</span><span class="p">(</span><span class="n">generate_note_record_ids</span><span class="p">(</span>
            <span class="n">convert_time_fields</span><span class="p">(</span><span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">lines</span><span class="p">))))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">records</span> <span class="o">=</span> <span class="p">[</span><span class="n">complete_record_ids</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">source_domain</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">csv</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span>
                <span class="s">&#39;The CSV file is formatted incorrectly. (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">notes_written</span><span class="p">,</span> <span class="n">notes_skipped</span><span class="p">,</span> <span class="n">notes_total</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">import_records</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="n">source_domain</span><span class="p">,</span> <span class="n">importer</span><span class="o">.</span><span class="n">create_note</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span>
            <span class="n">believed_dead_permission</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">believed_dead_permission</span><span class="p">,</span>
            <span class="n">omit_duplicate_notes</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">utils</span><span class="o">.</span><span class="n">log_api_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ApiActionLog</span><span class="o">.</span><span class="n">WRITE</span><span class="p">,</span>
                             <span class="mi">0</span><span class="p">,</span> <span class="n">notes_written</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">notes_skipped</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;import.html&#39;</span><span class="p">,</span>
                    <span class="n">formats</span><span class="o">=</span><span class="n">get_requested_formats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
                    <span class="n">stats</span><span class="o">=</span><span class="p">[</span>
                        <span class="n">Struct</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;Note&#39;</span><span class="p">,</span>
                               <span class="n">written</span><span class="o">=</span><span class="n">notes_written</span><span class="p">,</span>
                               <span class="n">skipped</span><span class="o">=</span><span class="n">notes_skipped</span><span class="p">,</span>
                               <span class="n">total</span><span class="o">=</span><span class="n">notes_total</span><span class="p">)],</span>
                    <span class="o">**</span><span class="n">get_tag_params</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Import.import_persons"><a class="viewcode-back" href="../api.html#api.Import.import_persons">[docs]</a>    <span class="k">def</span> <span class="nf">import_persons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="c"># TODO(ryok): support non-UTF8 encodings.</span>

        <span class="n">source_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">domain_write_permission</span>
        <span class="n">records</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">utf8_decoder</span><span class="p">(</span><span class="n">convert_time_fields</span><span class="p">(</span><span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">lines</span><span class="p">)))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">records</span> <span class="o">=</span> <span class="p">[</span><span class="n">complete_record_ids</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">source_domain</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">csv</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span>
                <span class="s">&#39;The CSV file is formatted incorrectly. (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">is_not_empty</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">persons</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span> <span class="k">if</span> <span class="n">is_not_empty</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;full_name&#39;</span><span class="p">))]</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span> <span class="k">if</span> <span class="n">is_not_empty</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;note_record_id&#39;</span><span class="p">))]</span>

        <span class="n">people_written</span><span class="p">,</span> <span class="n">people_skipped</span><span class="p">,</span> <span class="n">people_total</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">import_records</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="n">source_domain</span><span class="p">,</span> <span class="n">importer</span><span class="o">.</span><span class="n">create_person</span><span class="p">,</span> <span class="n">persons</span><span class="p">)</span>
        <span class="n">notes_written</span><span class="p">,</span> <span class="n">notes_skipped</span><span class="p">,</span> <span class="n">notes_total</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">import_records</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="n">source_domain</span><span class="p">,</span> <span class="n">importer</span><span class="o">.</span><span class="n">create_note</span><span class="p">,</span> <span class="n">notes</span><span class="p">,</span>
            <span class="n">believed_dead_permission</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">believed_dead_permission</span><span class="p">)</span>

        <span class="n">utils</span><span class="o">.</span><span class="n">log_api_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ApiActionLog</span><span class="o">.</span><span class="n">WRITE</span><span class="p">,</span>
                             <span class="n">people_written</span><span class="p">,</span> <span class="n">notes_written</span><span class="p">,</span>
                             <span class="nb">len</span><span class="p">(</span><span class="n">people_skipped</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">notes_skipped</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;import.html&#39;</span><span class="p">,</span>
                    <span class="n">formats</span><span class="o">=</span><span class="n">get_requested_formats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
                    <span class="n">stats</span><span class="o">=</span><span class="p">[</span>
                        <span class="n">Struct</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;Person&#39;</span><span class="p">,</span>
                               <span class="n">written</span><span class="o">=</span><span class="n">people_written</span><span class="p">,</span>
                               <span class="n">skipped</span><span class="o">=</span><span class="n">people_skipped</span><span class="p">,</span>
                               <span class="n">total</span><span class="o">=</span><span class="n">people_total</span><span class="p">),</span>
                        <span class="n">Struct</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;Note&#39;</span><span class="p">,</span>
                               <span class="n">written</span><span class="o">=</span><span class="n">notes_written</span><span class="p">,</span>
                               <span class="n">skipped</span><span class="o">=</span><span class="n">notes_skipped</span><span class="p">,</span>
                               <span class="n">total</span><span class="o">=</span><span class="n">notes_total</span><span class="p">)],</span>
                    <span class="o">**</span><span class="n">get_tag_params</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

</div></div>
<div class="viewcode-block" id="Read"><a class="viewcode-back" href="../api.html#api.Read">[docs]</a><span class="k">class</span> <span class="nc">Read</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="n">https_required</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="Read.get"><a class="viewcode-back" href="../api.html#api.Read.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">read_auth_key_required</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">read_permission</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="mi">403</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s">&#39;Missing or invalid authorization key&#39;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="s">&#39;plain&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">pfif_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">version</span>

        <span class="c"># Note that self.request.get can handle multiple IDs at once; we</span>
        <span class="c"># can consider adding support for multiple records later.</span>
        <span class="n">record_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">record_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&#39;Missing id parameter&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&#39;plain&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">person</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Person</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="n">record_id</span><span class="p">,</span> <span class="n">filter_expired</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">person</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="mi">400</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s">&#39;No person record with ID </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">record_id</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="s">&#39;plain&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Note</span><span class="o">.</span><span class="n">get_by_person_record_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="n">record_id</span><span class="p">)</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="p">[</span><span class="n">note</span> <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">notes</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">note</span><span class="o">.</span><span class="n">hidden</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;application/xml&#39;</span>
        <span class="n">records</span> <span class="o">=</span> <span class="p">[</span><span class="n">pfif_version</span><span class="o">.</span><span class="n">person_to_dict</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">is_expired</span><span class="p">)]</span>
        <span class="n">note_records</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">pfif_version</span><span class="o">.</span><span class="n">note_to_dict</span><span class="p">,</span> <span class="n">notes</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">optionally_filter_sensitive_fields</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">optionally_filter_sensitive_fields</span><span class="p">(</span><span class="n">note_records</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
        <span class="n">pfif_version</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">note_records</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">log_api_action</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">ApiActionLog</span><span class="o">.</span><span class="n">READ</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">notes</span><span class="p">))</span>

</div></div>
<div class="viewcode-block" id="PhotoUpload"><a class="viewcode-back" href="../api.html#api.PhotoUpload">[docs]</a><span class="k">class</span> <span class="nc">PhotoUpload</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="n">https_required</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="PhotoUpload.post"><a class="viewcode-back" href="../api.html#api.PhotoUpload.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">domain_write_permission</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="mi">403</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s">&#39;Missing or invalid authorization key&#39;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="s">&#39;plain&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c"># Check for empty body</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s">&quot;Request body must not be empty&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c"># Size check for uploaded file</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PHOTO_UPLOAD_MAX_SIZE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s">&quot;Size of uploaded file is greater than 10MB&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">photo_img</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
            <span class="n">photo</span><span class="p">,</span> <span class="n">photo_url</span> <span class="o">=</span> <span class="n">create_photo</span><span class="p">(</span><span class="n">photo_img</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">PhotoError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

        <span class="c"># If we reached this point, it means photo is filled properly</span>
        <span class="c"># So feel free to use it right away!</span>
        <span class="n">photo</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;application/xml&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;?xml version=&quot;1.0&quot;?&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;response&gt;&lt;url&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">django</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">photo_url</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;/url&gt;&lt;/response&gt;&#39;</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="Write"><a class="viewcode-back" href="../api.html#api.Write">[docs]</a><span class="k">class</span> <span class="nc">Write</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="n">https_required</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="Write.post"><a class="viewcode-back" href="../api.html#api.Write.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">domain_write_permission</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="mi">403</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s">&#39;Missing or invalid authorization key&#39;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="s">&#39;plain&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">source_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">domain_write_permission</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">person_records</span><span class="p">,</span> <span class="n">note_records</span> <span class="o">=</span> \
                <span class="n">pfif</span><span class="o">.</span><span class="n">parse_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">body_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&#39;Invalid XML: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&#39;plain&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">mark_notes_reviewed</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">mark_notes_reviewed</span><span class="p">)</span>
        <span class="n">believed_dead_permission</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">believed_dead_permission</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;application/xml&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;?xml version=&quot;1.0&quot;?&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;status:status&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="n">create_person</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">create_person</span>
        <span class="n">num_people_written</span><span class="p">,</span> <span class="n">people_skipped</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">import_records</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="n">source_domain</span><span class="p">,</span> <span class="n">create_person</span><span class="p">,</span> <span class="n">person_records</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_status</span><span class="p">(</span>
            <span class="s">&#39;person&#39;</span><span class="p">,</span> <span class="n">num_people_written</span><span class="p">,</span> <span class="n">people_skipped</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> 
            <span class="s">&#39;person_record_id&#39;</span><span class="p">)</span>

        <span class="n">create_note</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">create_note</span>
        <span class="n">num_notes_written</span><span class="p">,</span> <span class="n">notes_skipped</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">import_records</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="n">source_domain</span><span class="p">,</span> <span class="n">create_note</span><span class="p">,</span> <span class="n">note_records</span><span class="p">,</span>
            <span class="n">mark_notes_reviewed</span><span class="p">,</span> <span class="n">believed_dead_permission</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_status</span><span class="p">(</span>
            <span class="s">&#39;note&#39;</span><span class="p">,</span> <span class="n">num_notes_written</span><span class="p">,</span> <span class="n">notes_skipped</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="s">&#39;note_record_id&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;/status:status&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">log_api_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ApiActionLog</span><span class="o">.</span><span class="n">WRITE</span><span class="p">,</span>          
                             <span class="n">num_people_written</span><span class="p">,</span> <span class="n">num_notes_written</span><span class="p">,</span>  
                             <span class="nb">len</span><span class="p">(</span><span class="n">people_skipped</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">notes_skipped</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="Write.write_status"><a class="viewcode-back" href="../api.html#api.Write.write_status">[docs]</a>    <span class="k">def</span> <span class="nf">write_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">written</span><span class="p">,</span> <span class="n">skipped</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">id_field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Emit status information about the results of an attempted write.&quot;&quot;&quot;</span>
        <span class="n">skipped_records</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">error</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">skipped</span><span class="p">:</span>
            <span class="n">skipped_records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s">&#39;      &lt;pfif:</span><span class="si">%s</span><span class="s">&gt;</span><span class="si">%s</span><span class="s">&lt;/pfif:</span><span class="si">%s</span><span class="s">&gt;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">id_field</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">id_field</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span> <span class="n">id_field</span><span class="p">))</span>
            <span class="n">skipped_records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s">&#39;      &lt;status:error&gt;</span><span class="si">%s</span><span class="s">&lt;/status:error&gt;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span>
<span class="s">  &lt;status:write&gt;</span>
<span class="s">    &lt;status:record_type&gt;pfif:</span><span class="si">%s</span><span class="s">&lt;/status:record_type&gt;</span>
<span class="s">    &lt;status:parsed&gt;</span><span class="si">%d</span><span class="s">&lt;/status:parsed&gt;</span>
<span class="s">    &lt;status:written&gt;</span><span class="si">%d</span><span class="s">&lt;/status:written&gt;</span>
<span class="s">    &lt;status:skipped&gt;</span>
<span class="si">%s</span><span class="s"></span>
<span class="s">    &lt;/status:skipped&gt;</span>
<span class="s">  &lt;/status:write&gt;</span>
<span class="s">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">written</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">skipped_records</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()))</span>

</div></div>
<div class="viewcode-block" id="Search"><a class="viewcode-back" href="../api.html#api.Search">[docs]</a><span class="k">class</span> <span class="nc">Search</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="n">https_required</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="Search.get"><a class="viewcode-back" href="../api.html#api.Search.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">search_auth_key_required</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">search_permission</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="mi">403</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s">&#39;Missing or invalid authorization key&#39;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="s">&#39;plain&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">pfif_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">version</span>

        <span class="c"># Retrieve parameters and do some sanity checks on them.</span>
        <span class="n">record_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>
        <span class="n">query_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;q&#39;</span><span class="p">)</span>
        <span class="n">max_results</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_results</span> <span class="ow">or</span> <span class="mi">100</span><span class="p">,</span> <span class="n">HARD_MAX_RESULTS</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">record_id</span><span class="p">:</span>
            <span class="c"># Search by record ID (always returns just 1 result or nothing).</span>
            <span class="n">person</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Person</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="n">record_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">person</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">person</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">query_string</span><span class="p">:</span>
            <span class="c"># Search by query words.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">external_search_backends</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">TextQuery</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">external_search</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">max_results</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">external_search_backends</span><span class="p">)</span>
            <span class="c"># External search backends are not always complete. Fall back to</span>
            <span class="c"># the original search when they fail or return no results.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;enable_fulltext_search&#39;</span><span class="p">):</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">full_text_search</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="n">query_string</span><span class="p">,</span> <span class="n">max_results</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">indexing</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="n">TextQuery</span><span class="p">(</span><span class="n">query_string</span><span class="p">),</span> <span class="n">max_results</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="mi">400</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s">&#39;Neither id nor q parameter specified&#39;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="s">&#39;plain&#39;</span><span class="p">)</span>

        <span class="n">records</span> <span class="o">=</span> <span class="p">[</span><span class="n">pfif_version</span><span class="o">.</span><span class="n">person_to_dict</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">optionally_filter_sensitive_fields</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>

        <span class="c"># Define the function to retrieve notes for a person.</span>
        <span class="k">def</span> <span class="nf">get_notes_for_person</span><span class="p">(</span><span class="n">person</span><span class="p">):</span>
            <span class="n">notes</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Note</span><span class="o">.</span><span class="n">get_by_person_record_id</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="n">person</span><span class="p">[</span><span class="s">&#39;person_record_id&#39;</span><span class="p">])</span>
            <span class="n">notes</span> <span class="o">=</span> <span class="p">[</span><span class="n">note</span> <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">notes</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">note</span><span class="o">.</span><span class="n">hidden</span><span class="p">]</span>
            <span class="n">records</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">pfif_version</span><span class="o">.</span><span class="n">note_to_dict</span><span class="p">,</span> <span class="n">notes</span><span class="p">)</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">optionally_filter_sensitive_fields</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">records</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;application/xml&#39;</span>
        <span class="n">pfif_version</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span> <span class="n">get_notes_for_person</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">log_api_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ApiActionLog</span><span class="o">.</span><span class="n">SEARCH</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">))</span>

</div></div>
<div class="viewcode-block" id="Subscribe"><a class="viewcode-back" href="../api.html#api.Subscribe">[docs]</a><span class="k">class</span> <span class="nc">Subscribe</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="n">https_required</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="Subscribe.post"><a class="viewcode-back" href="../api.html#api.Subscribe.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">subscribe_permission</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s">&#39;Missing or invalid authorization key&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">subscribe</span><span class="o">.</span><span class="n">is_email_valid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">subscribe_email</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s">&#39;Invalid email address&#39;</span><span class="p">)</span>

        <span class="n">person</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Person</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">person</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s">&#39;Invalid person_record_id&#39;</span><span class="p">)</span>

        <span class="n">subscription</span> <span class="o">=</span> <span class="n">subscribe</span><span class="o">.</span><span class="n">subscribe_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="n">person</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">subscribe_email</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">log_api_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ApiActionLog</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subscription</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s">&#39;Already subscribed&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s">&#39;Successfully subscribed&#39;</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="Unsubscribe"><a class="viewcode-back" href="../api.html#api.Unsubscribe">[docs]</a><span class="k">class</span> <span class="nc">Unsubscribe</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="n">https_required</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="Unsubscribe.post"><a class="viewcode-back" href="../api.html#api.Unsubscribe.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">subscribe_permission</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s">&#39;Missing or invalid authorization key&#39;</span><span class="p">)</span>

        <span class="n">subscription</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Subscription</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">subscribe_email</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">log_api_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ApiActionLog</span><span class="o">.</span><span class="n">UNSUBSCRIBE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subscription</span><span class="p">:</span>
            <span class="n">subscription</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s">&#39;Successfully unsubscribed&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s">&#39;Not subscribed&#39;</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="fetch_all"><a class="viewcode-back" href="../api.html#api.fetch_all">[docs]</a><span class="k">def</span> <span class="nf">fetch_all</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">batch</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">+=</span> <span class="n">batch</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">with_cursor</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">cursor</span><span class="p">())</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span>

</div>
<div class="viewcode-block" id="Stats"><a class="viewcode-back" href="../api.html#api.Stats">[docs]</a><span class="k">class</span> <span class="nc">Stats</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">BaseHandler</span><span class="p">):</span>
<div class="viewcode-block" id="Stats.get"><a class="viewcode-back" href="../api.html#api.Stats.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">stats_permission</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="mi">403</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s">&#39;Missing or invalid authorization key&#39;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="s">&#39;plain&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">person_counts</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Counter</span><span class="o">.</span><span class="n">get_all_counts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="s">&#39;person&#39;</span><span class="p">)</span>
        <span class="n">note_counts</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Counter</span><span class="o">.</span><span class="n">get_all_counts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="s">&#39;note&#39;</span><span class="p">)</span>

        <span class="c"># unreviewed</span>
        <span class="n">note_counts</span><span class="p">[</span><span class="s">&#39;hidden=FALSE,reviewed=FALSE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fetch_all</span><span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">Note</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">keys_only</span><span class="o">=</span><span class="bp">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;repo =&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;reviewed =&#39;</span><span class="p">,</span> <span class="bp">False</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;hidden =&#39;</span><span class="p">,</span> <span class="bp">False</span>
            <span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s">&#39;-entry_date&#39;</span><span class="p">)))</span>
        <span class="c"># accepted</span>
        <span class="n">note_counts</span><span class="p">[</span><span class="s">&#39;hidden=FALSE,reviewed=TRUE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fetch_all</span><span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">Note</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">keys_only</span><span class="o">=</span><span class="bp">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;repo =&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;reviewed =&#39;</span><span class="p">,</span> <span class="bp">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;hidden =&#39;</span><span class="p">,</span> <span class="bp">False</span>
            <span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s">&#39;-entry_date&#39;</span><span class="p">)))</span>
        <span class="c"># flagged</span>
        <span class="n">note_counts</span><span class="p">[</span><span class="s">&#39;hidden=TRUE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fetch_all</span><span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">Note</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">keys_only</span><span class="o">=</span><span class="bp">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;repo =&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;hidden =&#39;</span><span class="p">,</span> <span class="bp">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s">&#39;-entry_date&#39;</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;person&#39;</span><span class="p">:</span> <span class="n">person_counts</span><span class="p">,</span>
                                     <span class="s">&#39;note&#39;</span><span class="p">:</span> <span class="n">note_counts</span><span class="p">}))</span>

</div></div>
<div class="viewcode-block" id="HandleSMS"><a class="viewcode-back" href="../api.html#api.HandleSMS">[docs]</a><span class="k">class</span> <span class="nc">HandleSMS</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="n">https_required</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">repo_required</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">MAX_RESULTS</span> <span class="o">=</span> <span class="mi">3</span>

<div class="viewcode-block" id="HandleSMS.post"><a class="viewcode-back" href="../api.html#api.HandleSMS.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">search_permission</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">domain_write_permission</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="mi">403</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span>
                    <span class="s">&#39;&quot;key&quot; URL parameter is either missing, invalid or &#39;</span>
                    <span class="s">&#39;lacks required permissions. The key</span><span class="se">\&#39;</span><span class="s">s repo must be &quot;*&quot;, &#39;</span>
                    <span class="s">&#39;search_permission must be True, and it must have write &#39;</span>
                    <span class="s">&#39;permission.&#39;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="s">&#39;plain&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">body_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">dom</span><span class="o">.</span><span class="n">minidom</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">message_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_element_text</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s">&#39;message_text&#39;</span><span class="p">)</span>
        <span class="n">receiver_phone_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_element_text</span><span class="p">(</span>
            <span class="n">doc</span><span class="p">,</span> <span class="s">&#39;receiver_phone_number&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">message_text</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="mi">400</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s">&#39;message_text element is required.&#39;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="s">&#39;plain&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">receiver_phone_number</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="mi">400</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s">&#39;receiver_phone_number element is required.&#39;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="s">&#39;plain&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">repo</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sms_number_to_repo</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sms_number_to_repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">receiver_phone_number</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">repo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="mi">400</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span>
                    <span class="s">&#39;The given receiver_phone_number is not found in &#39;</span>
                    <span class="s">&#39;sms_number_to_repo config.&#39;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="s">&#39;plain&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">search_m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;^search\s+(.+)$&#39;</span><span class="p">,</span> <span class="n">message_text</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
        <span class="n">add_self_m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;^i am\s+(.+)$&#39;</span><span class="p">,</span> <span class="n">message_text</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">search_m</span><span class="p">:</span>
            <span class="n">query_string</span> <span class="o">=</span> <span class="n">search_m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">TextQuery</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
            <span class="n">persons</span> <span class="o">=</span> <span class="n">indexing</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">HandleSMS</span><span class="o">.</span><span class="n">MAX_RESULTS</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">persons</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">persons</span><span class="p">:</span>
                    <span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">render_person</span><span class="p">(</span><span class="n">person</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;No results found for: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">query_string</span><span class="p">)</span>
            <span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s">&#39;More at: google.org/personfinder/</span><span class="si">%s</span><span class="s">?ui=light&#39;</span> <span class="o">%</span> <span class="n">repo</span><span class="p">)</span>
            <span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s">&#39;All data entered in Person Finder is available to the public &#39;</span>
                <span class="s">&#39;and usable by anyone. Google does not review or verify the &#39;</span>
                <span class="s">&#39;accuracy of this data google.org/personfinder/global/tos.html&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enable_sms_record_input</span> <span class="ow">and</span> <span class="n">add_self_m</span><span class="p">:</span>
            <span class="n">name_string</span> <span class="o">=</span> <span class="n">add_self_m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">person</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">create_original</span><span class="p">(</span>
                <span class="n">repo</span><span class="p">,</span>
                <span class="n">entry_date</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">get_utcnow</span><span class="p">(),</span>
                <span class="n">full_name</span><span class="o">=</span><span class="n">name_string</span><span class="p">,</span>
                <span class="n">family_name</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                <span class="n">given_name</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">person</span><span class="o">.</span><span class="n">update_index</span><span class="p">([</span><span class="s">&#39;old&#39;</span><span class="p">,</span> <span class="s">&#39;new&#39;</span><span class="p">])</span>
            <span class="n">note</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">create_original</span><span class="p">(</span>
                <span class="n">repo</span><span class="p">,</span>
                <span class="n">entry_date</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">get_utcnow</span><span class="p">(),</span>
                <span class="n">source_date</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">get_utcnow</span><span class="p">(),</span>
                <span class="n">person_record_id</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">record_id</span><span class="p">,</span>
                <span class="n">author_name</span><span class="o">=</span><span class="n">name_string</span><span class="p">,</span>
                <span class="n">author_made_contact</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s">&#39;is_note_author&#39;</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="n">message_text</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">note</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">UserActionLog</span><span class="o">.</span><span class="n">put_new</span><span class="p">(</span><span class="s">&#39;add&#39;</span><span class="p">,</span> <span class="n">note</span><span class="p">,</span> <span class="n">copy_properties</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">person</span><span class="o">.</span><span class="n">update_from_note</span><span class="p">(</span><span class="n">note</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">UserActionLog</span><span class="o">.</span><span class="n">put_new</span><span class="p">(</span><span class="s">&#39;add&#39;</span><span class="p">,</span> <span class="n">person</span><span class="p">,</span> <span class="n">copy_properties</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;Added record for found person: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">name_string</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">usage_str</span> <span class="o">=</span> <span class="s">&#39;Usage: &quot;Search John&quot;&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enable_sms_record_input</span><span class="p">:</span>
              <span class="n">usage_str</span> <span class="o">+=</span> <span class="s">&#39; OR &quot;I am John&quot;&#39;</span>
            <span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">usage_str</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;application/xml&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="s">&#39;&lt;response&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="s">&#39;  &lt;message_text&gt;</span><span class="si">%s</span><span class="s">&lt;/message_text&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="s">&#39;&lt;/response&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="o">%</span> <span class="n">django</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s">&#39; ## &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">responses</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="HandleSMS.render_person"><a class="viewcode-back" href="../api.html#api.HandleSMS.render_person">[docs]</a>    <span class="k">def</span> <span class="nf">render_person</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="n">latest_status</span><span class="p">:</span>
            <span class="c"># The result of utils.get_person_status_text() may be a Django&#39;s</span>
            <span class="c"># proxy object for lazy translation. Use unicode() to convert it</span>
            <span class="c"># into a unicode object. We must not specify an encoding for</span>
            <span class="c"># unicode() in this case.</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">get_person_status_text</span><span class="p">(</span><span class="n">person</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="n">sex</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">sex</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="n">age</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">age</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="n">home_city</span> <span class="ow">or</span> <span class="n">person</span><span class="o">.</span><span class="n">home_state</span><span class="p">:</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s">&#39;From: &#39;</span> <span class="o">+</span>
                <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="p">[</span><span class="n">person</span><span class="o">.</span><span class="n">home_city</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">home_state</span><span class="p">])))</span>
        <span class="k">return</span> <span class="s">&#39; / &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HandleSMS.get_element_text"><a class="viewcode-back" href="../api.html#api.HandleSMS.get_element_text">[docs]</a>    <span class="k">def</span> <span class="nf">get_element_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">):</span>
        <span class="n">elems</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">elems</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s">u&#39;&#39;</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">childNodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">nodeType</span> <span class="o">==</span> <span class="n">node</span><span class="o">.</span><span class="n">TEXT_NODE</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">+=</span> <span class="n">node</span><span class="o">.</span><span class="n">data</span>
            <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.6</a>
      
    </div>

    

    
  </body>
</html>