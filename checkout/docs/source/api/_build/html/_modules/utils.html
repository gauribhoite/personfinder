<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>utils &mdash; app  documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="app  documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for utils</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/python2.7</span>
<span class="c"># Copyright 2010 Google Inc.</span>
<span class="c">#</span>
<span class="c"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c"># you may not use this file except in compliance with the License.</span>
<span class="c"># You may obtain a copy of the License at</span>
<span class="c">#</span>
<span class="c">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">#</span>
<span class="c"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c"># See the License for the specific language governing permissions and</span>
<span class="c"># limitations under the License.</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;kpy@google.com (Ka-Ping Yee) and many other Googlers&#39;</span>

<span class="kn">from</span> <span class="nn">django_setup</span> <span class="kn">import</span> <span class="n">ugettext</span> <span class="k">as</span> <span class="n">_</span>  <span class="c"># always keep this first</span>

<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">cgi</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">httplib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">unicodedata</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">urlparse</span>
<span class="kn">import</span> <span class="nn">base64</span>

<span class="kn">import</span> <span class="nn">django.utils.html</span>
<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">images</span>
<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">mail</span>
<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">taskqueue</span>
<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">users</span>
<span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">webapp</span>
<span class="kn">import</span> <span class="nn">google.appengine.ext.webapp.template</span>
<span class="kn">import</span> <span class="nn">google.appengine.ext.webapp.util</span>
<span class="kn">from</span> <span class="nn">recaptcha.client</span> <span class="kn">import</span> <span class="n">captcha</span>
<span class="kn">from</span> <span class="nn">babel.dates</span> <span class="kn">import</span> <span class="n">format_datetime</span>
<span class="kn">import</span> <span class="nn">babel</span>

<span class="kn">import</span> <span class="nn">const</span>
<span class="kn">import</span> <span class="nn">config</span>
<span class="kn">import</span> <span class="nn">model</span>
<span class="kn">import</span> <span class="nn">pfif</span>
<span class="kn">import</span> <span class="nn">resources</span>

<span class="c"># The domain name from which to send e-mail.</span>
<span class="n">EMAIL_DOMAIN</span> <span class="o">=</span> <span class="s">&#39;appspotmail.com&#39;</span>  <span class="c"># All apps on appspot.com use this for mail.</span>

<span class="c"># Query parameters which are automatically preserved on page transition</span>
<span class="c"># if you use utils.BaseHandler.get_url() or</span>
<span class="c"># env.hidden_input_tags_for_preserved_query_params.</span>
<span class="n">PRESERVED_QUERY_PARAM_NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;ui&#39;</span><span class="p">,</span> <span class="s">&#39;charsets&#39;</span><span class="p">,</span> <span class="s">&#39;referrer&#39;</span><span class="p">]</span>


<span class="c"># ==== Field value text ========================================================</span>

<div class="viewcode-block" id="get_person_sex_text"><a class="viewcode-back" href="../utils.html#admin_api_keys.get_person_sex_text">[docs]</a><span class="k">def</span> <span class="nf">get_person_sex_text</span><span class="p">(</span><span class="n">person</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the UI text for a person&#39;s sex field.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">const</span><span class="o">.</span><span class="n">PERSON_SEX_TEXT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">sex</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="get_note_status_text"><a class="viewcode-back" href="../utils.html#admin_api_keys.get_note_status_text">[docs]</a><span class="k">def</span> <span class="nf">get_note_status_text</span><span class="p">(</span><span class="n">note</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the UI text for a note&#39;s status field.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">const</span><span class="o">.</span><span class="n">NOTE_STATUS_TEXT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">note</span><span class="o">.</span><span class="n">status</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="get_person_status_text"><a class="viewcode-back" href="../utils.html#admin_api_keys.get_person_status_text">[docs]</a><span class="k">def</span> <span class="nf">get_person_status_text</span><span class="p">(</span><span class="n">person</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the UI text for a person&#39;s latest_status.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">const</span><span class="o">.</span><span class="n">PERSON_STATUS_TEXT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">latest_status</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

<span class="c"># Things that occur as prefixes of global paths (i.e. no repository name).</span></div>
<span class="n">GLOBAL_PATH_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^/(global|personfinder)(/?|/.*)$&#39;</span><span class="p">)</span>


<span class="c"># ==== String formatting =======================================================</span>

<div class="viewcode-block" id="format_boolean"><a class="viewcode-back" href="../utils.html#admin_api_keys.format_boolean">[docs]</a><span class="k">def</span> <span class="nf">format_boolean</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span> <span class="ow">and</span> <span class="s">&#39;true&#39;</span> <span class="ow">or</span> <span class="s">&#39;false&#39;</span>
</div>
<div class="viewcode-block" id="format_utc_datetime"><a class="viewcode-back" href="../utils.html#admin_api_keys.format_utc_datetime">[docs]</a><span class="k">def</span> <span class="nf">format_utc_datetime</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dt</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>
    <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;Z&#39;</span>
</div>
<div class="viewcode-block" id="format_utc_timestamp"><a class="viewcode-back" href="../utils.html#admin_api_keys.format_utc_timestamp">[docs]</a><span class="k">def</span> <span class="nf">format_utc_timestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>
    <span class="k">return</span> <span class="n">format_utc_datetime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="format_sitemaps_datetime"><a class="viewcode-back" href="../utils.html#admin_api_keys.format_sitemaps_datetime">[docs]</a><span class="k">def</span> <span class="nf">format_sitemaps_datetime</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
    <span class="n">integer_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span>
        <span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">integer_dt</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;+00:00&#39;</span>
</div>
<div class="viewcode-block" id="encode"><a class="viewcode-back" href="../utils.html#admin_api_keys.encode">[docs]</a><span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;If unicode, encode to encoding; if 8-bit string, leave unchanged.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">string</span>
</div>
<div class="viewcode-block" id="urlencode"><a class="viewcode-back" href="../utils.html#admin_api_keys.urlencode">[docs]</a><span class="k">def</span> <span class="nf">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Encode the key-value pairs in &#39;params&#39; into a query string, applying</span>
<span class="sd">    the specified encoding to any Unicode strings and ignoring any keys that</span>
<span class="sd">    have value == None.  (urllib.urlencode doesn&#39;t support Unicode).&quot;&quot;&quot;</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c"># Sort the keys to get canonical ordering</span>
    <span class="k">return</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">([</span>
        <span class="p">(</span><span class="n">encode</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">encoding</span><span class="p">),</span> <span class="n">encode</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">encoding</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">basestring</span><span class="p">)])</span>
</div>
<div class="viewcode-block" id="set_param"><a class="viewcode-back" href="../utils.html#admin_api_keys.set_param">[docs]</a><span class="k">def</span> <span class="nf">set_param</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Take the params from a urlparse and override one of the values.&quot;&quot;&quot;</span>
    <span class="c"># This will strip out None-valued params and collapse repeated params.</span>
    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cgi</span><span class="o">.</span><span class="n">parse_qsl</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">del</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="set_url_param"><a class="viewcode-back" href="../utils.html#admin_api_keys.set_url_param">[docs]</a><span class="k">def</span> <span class="nf">set_url_param</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This modifies a URL setting the given param to the specified value.  This</span>
<span class="sd">    may add the param or override an existing value, or, if the value is None,</span>
<span class="sd">    it will remove the param.  Note that value must be a basestring and can&#39;t be</span>
<span class="sd">    an int, for example.&quot;&quot;&quot;</span>
    <span class="n">url_parts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
    <span class="n">url_parts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_param</span><span class="p">(</span><span class="n">url_parts</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlunparse</span><span class="p">(</span><span class="n">url_parts</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="anchor_start"><a class="viewcode-back" href="../utils.html#admin_api_keys.anchor_start">[docs]</a><span class="k">def</span> <span class="nf">anchor_start</span><span class="p">(</span><span class="n">href</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the HREF escaped and embedded in an anchor tag.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s">&#39;&lt;a href=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;&#39;</span> <span class="o">%</span> <span class="n">django</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">href</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="anchor"><a class="viewcode-back" href="../utils.html#admin_api_keys.anchor">[docs]</a><span class="k">def</span> <span class="nf">anchor</span><span class="p">(</span><span class="n">href</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a string anchor HTML element with the given href and body.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">anchor_start</span><span class="p">(</span><span class="n">href</span><span class="p">)</span> <span class="o">+</span> <span class="n">django</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&lt;/a&gt;&#39;</span>


<span class="c"># ==== Validators ==============================================================</span>

<span class="c"># These validator functions are used to check and parse query parameters.</span>
<span class="c"># Each validator should return a parsed, sanitized value, or return a default</span>
<span class="c"># value, or raise ValueError to display an error message to the user.</span>
</div>
<div class="viewcode-block" id="strip"><a class="viewcode-back" href="../utils.html#admin_api_keys.strip">[docs]</a><span class="k">def</span> <span class="nf">strip</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="c"># Trailing nulls appear in some strange character encodings like Shift-JIS.</span>
    <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="strip_and_lower"><a class="viewcode-back" href="../utils.html#admin_api_keys.strip_and_lower">[docs]</a><span class="k">def</span> <span class="nf">strip_and_lower</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">strip</span><span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="validate_yes"><a class="viewcode-back" href="../utils.html#admin_api_keys.validate_yes">[docs]</a><span class="k">def</span> <span class="nf">validate_yes</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">strip</span><span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;yes&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s">&#39;yes&#39;</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
</div>
<div class="viewcode-block" id="validate_checkbox"><a class="viewcode-back" href="../utils.html#admin_api_keys.validate_checkbox">[docs]</a><span class="k">def</span> <span class="nf">validate_checkbox</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">strip</span><span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;on&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s">&#39;yes&#39;</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
</div>
<div class="viewcode-block" id="validate_checkbox_as_bool"><a class="viewcode-back" href="../utils.html#admin_api_keys.validate_checkbox_as_bool">[docs]</a><span class="k">def</span> <span class="nf">validate_checkbox_as_bool</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;on&#39;</span><span class="p">,</span> <span class="s">&#39;yes&#39;</span><span class="p">,</span> <span class="s">&#39;true&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="validate_role"><a class="viewcode-back" href="../utils.html#admin_api_keys.validate_role">[docs]</a><span class="k">def</span> <span class="nf">validate_role</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">strip</span><span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;provide&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s">&#39;provide&#39;</span> <span class="ow">or</span> <span class="s">&#39;seek&#39;</span>
</div>
<div class="viewcode-block" id="validate_int"><a class="viewcode-back" href="../utils.html#admin_api_keys.validate_int">[docs]</a><span class="k">def</span> <span class="nf">validate_int</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">string</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">strip</span><span class="p">(</span><span class="n">string</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="validate_sex"><a class="viewcode-back" href="../utils.html#admin_api_keys.validate_sex">[docs]</a><span class="k">def</span> <span class="nf">validate_sex</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validates the &#39;sex&#39; parameter, returning a canonical value or &#39;&#39;.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">string</span><span class="p">:</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">strip</span><span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">pfif</span><span class="o">.</span><span class="n">PERSON_SEX_VALUES</span> <span class="ow">and</span> <span class="n">string</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
</div>
<div class="viewcode-block" id="validate_expiry"><a class="viewcode-back" href="../utils.html#admin_api_keys.validate_expiry">[docs]</a><span class="k">def</span> <span class="nf">validate_expiry</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validates that the &#39;expiry_option&#39; parameter is a positive integer.</span>

<span class="sd">    Returns:</span>
<span class="sd">      the int() value if it&#39;s present and parses, or the default_expiry_days</span>
<span class="sd">      for the repository, if it&#39;s set, otherwise -1 which represents the</span>
<span class="sd">      &#39;unspecified&#39; status.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">or</span> <span class="bp">None</span>
</div>
<span class="n">APPROXIMATE_DATE_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^\d{4}(-\d\d)?(-\d\d)?$&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="validate_approximate_date"><a class="viewcode-back" href="../utils.html#admin_api_keys.validate_approximate_date">[docs]</a><span class="k">def</span> <span class="nf">validate_approximate_date</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">string</span><span class="p">:</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">strip</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">APPROXIMATE_DATE_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">string</span>
    <span class="k">return</span> <span class="s">&#39;&#39;</span>
</div>
<span class="n">AGE_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^\d+(-\d+)?$&#39;</span><span class="p">)</span>
<span class="c"># Hyphen with possibly surrounding whitespaces.</span>
<span class="n">HYPHEN_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="s">ur&#39;\s*[-\u2010-\u2015\u2212\u301c\u30fc\ufe58\ufe63\uff0d]\s*&#39;</span><span class="p">,</span>
    <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>

<div class="viewcode-block" id="validate_age"><a class="viewcode-back" href="../utils.html#admin_api_keys.validate_age">[docs]</a><span class="k">def</span> <span class="nf">validate_age</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validates the &#39;age&#39; parameter, returning a canonical value or &#39;&#39;.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">string</span><span class="p">:</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">strip</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s">&#39;NFKC&#39;</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">string</span><span class="p">))</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">HYPHEN_RE</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">AGE_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">string</span>
    <span class="k">return</span> <span class="s">&#39;&#39;</span>
</div>
<div class="viewcode-block" id="validate_status"><a class="viewcode-back" href="../utils.html#admin_api_keys.validate_status">[docs]</a><span class="k">def</span> <span class="nf">validate_status</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validates an incoming status parameter, returning one of the canonical</span>
<span class="sd">    status strings or &#39;&#39;.  Note that &#39;&#39; is always used as the Python value</span>
<span class="sd">    to represent the &#39;unspecified&#39; status.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">string</span><span class="p">:</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">strip</span><span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">pfif</span><span class="o">.</span><span class="n">NOTE_STATUS_VALUES</span> <span class="ow">and</span> <span class="n">string</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
</div>
<span class="n">DATETIME_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^(2\d\d\d)-(\d\d)-(\d\d)T(\d\d):(\d\d):(\d\d)Z$&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="validate_datetime"><a class="viewcode-back" href="../utils.html#admin_api_keys.validate_datetime">[docs]</a><span class="k">def</span> <span class="nf">validate_datetime</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">string</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>  <span class="c"># A missing value is okay.</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">DATETIME_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()))</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Bad datetime: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">string</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="validate_timestamp"><a class="viewcode-back" href="../utils.html#admin_api_keys.validate_timestamp">[docs]</a><span class="k">def</span> <span class="nf">validate_timestamp</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">string</span> <span class="ow">and</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">strip</span><span class="p">(</span><span class="n">string</span><span class="p">)))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Bad timestamp: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">string</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="validate_image"><a class="viewcode-back" href="../utils.html#admin_api_keys.validate_image">[docs]</a><span class="k">def</span> <span class="nf">validate_image</span><span class="p">(</span><span class="n">bytestring</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">bytestring</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">bytestring</span><span class="p">)</span>
            <span class="n">image</span><span class="o">.</span><span class="n">width</span>
        <span class="k">return</span> <span class="n">image</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="validate_version"><a class="viewcode-back" href="../utils.html#admin_api_keys.validate_version">[docs]</a><span class="k">def</span> <span class="nf">validate_version</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Version, if present, should be in pfif versions.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">string</span> <span class="ow">and</span> <span class="n">strip</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pfif</span><span class="o">.</span><span class="n">PFIF_VERSIONS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Bad pfif version: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">string</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pfif</span><span class="o">.</span><span class="n">PFIF_VERSIONS</span><span class="p">[</span><span class="n">strip</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pfif</span><span class="o">.</span><span class="n">PFIF_DEFAULT_VERSION</span><span class="p">]</span>
</div>
<span class="n">REPO_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^[a-z0-9-]+$&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="validate_repo"><a class="viewcode-back" href="../utils.html#admin_api_keys.validate_repo">[docs]</a><span class="k">def</span> <span class="nf">validate_repo</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="n">string</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">string</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">string</span> <span class="o">==</span> <span class="s">&#39;global&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;&quot;global&quot; is an illegal repository name.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">REPO_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">string</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Repository names can only contain &#39;</span>
                     <span class="s">&#39;lowercase letters, digits, and hyphens.&#39;</span><span class="p">)</span>

</div>
<span class="n">RESOURCE_NAME_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^[a-z0-9._-]+$&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="validate_resource_name"><a class="viewcode-back" href="../utils.html#admin_api_keys.validate_resource_name">[docs]</a><span class="k">def</span> <span class="nf">validate_resource_name</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A resource name or bundle label.&quot;&quot;&quot;</span>
    <span class="n">string</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">string</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">RESOURCE_NAME_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">string</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Invalid resource name or bundle name: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">string</span><span class="p">)</span>

</div>
<span class="n">LANG_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^[A-Za-z0-9-]+$&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="validate_lang"><a class="viewcode-back" href="../utils.html#admin_api_keys.validate_lang">[docs]</a><span class="k">def</span> <span class="nf">validate_lang</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A BCP 47 language tag.&quot;&quot;&quot;</span>
    <span class="n">string</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">string</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">LANG_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">string</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Invalid language tag: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">string</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="validate_cache_seconds"><a class="viewcode-back" href="../utils.html#admin_api_keys.validate_cache_seconds">[docs]</a><span class="k">def</span> <span class="nf">validate_cache_seconds</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A number of seconds to cache a Resource in RAM.&quot;&quot;&quot;</span>
    <span class="n">string</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">string</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="k">return</span> <span class="mf">1.0</span>


<span class="c"># ==== Other utilities =========================================================</span>
</div>
<div class="viewcode-block" id="url_is_safe"><a class="viewcode-back" href="../utils.html#admin_api_keys.url_is_safe">[docs]</a><span class="k">def</span> <span class="nf">url_is_safe</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">current_scheme</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">current_scheme</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;http&#39;</span><span class="p">,</span> <span class="s">&#39;https&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="get_app_name"><a class="viewcode-back" href="../utils.html#admin_api_keys.get_app_name">[docs]</a><span class="k">def</span> <span class="nf">get_app_name</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Canonical name of the app, without HR s~ nonsense.  This only works in</span>
<span class="sd">    the context of the appserver (eg remote_api can&#39;t use it).&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">app_identity</span>
    <span class="k">return</span> <span class="n">app_identity</span><span class="o">.</span><span class="n">get_application_id</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="sanitize_urls"><a class="viewcode-back" href="../utils.html#admin_api_keys.sanitize_urls">[docs]</a><span class="k">def</span> <span class="nf">sanitize_urls</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Clean up URLs to protect against XSS.&quot;&quot;&quot;</span>
    <span class="c"># Single-line URLs.</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;photo_url&#39;</span><span class="p">,</span> <span class="s">&#39;source_url&#39;</span><span class="p">]:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">url</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">url_is_safe</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="c"># Multi-line URLs.</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;profile_urls&#39;</span><span class="p">]:</span>
        <span class="n">urls</span> <span class="o">=</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">sanitized_urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">url</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span> <span class="k">if</span> <span class="n">url</span> <span class="ow">and</span> <span class="n">url_is_safe</span><span class="p">(</span><span class="n">url</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sanitized_urls</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sanitized_urls</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="get_host"><a class="viewcode-back" href="../utils.html#admin_api_keys.get_host">[docs]</a><span class="k">def</span> <span class="nf">get_host</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">host</span> <span class="o">=</span> <span class="n">host</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;HTTP_HOST&#39;</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Return the host name, without version specific details.&quot;&quot;&quot;</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">host</span>
</div>
<div class="viewcode-block" id="optionally_filter_sensitive_fields"><a class="viewcode-back" href="../utils.html#admin_api_keys.optionally_filter_sensitive_fields">[docs]</a><span class="k">def</span> <span class="nf">optionally_filter_sensitive_fields</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Removes sensitive fields from a list of dictionaries, unless the client</span>
<span class="sd">    has full read authorization.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">auth</span> <span class="ow">and</span> <span class="n">auth</span><span class="o">.</span><span class="n">full_read_permission</span><span class="p">):</span>
        <span class="n">filter_sensitive_fields</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="filter_sensitive_fields"><a class="viewcode-back" href="../utils.html#admin_api_keys.filter_sensitive_fields">[docs]</a><span class="k">def</span> <span class="nf">filter_sensitive_fields</span><span class="p">(</span><span class="n">records</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Removes sensitive fields from a list of dictionaries.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;date_of_birth&#39;</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
            <span class="n">record</span><span class="p">[</span><span class="s">&#39;date_of_birth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="s">&#39;author_email&#39;</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
            <span class="n">record</span><span class="p">[</span><span class="s">&#39;author_email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="s">&#39;author_phone&#39;</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
            <span class="n">record</span><span class="p">[</span><span class="s">&#39;author_phone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="s">&#39;email_of_found_person&#39;</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
            <span class="n">record</span><span class="p">[</span><span class="s">&#39;email_of_found_person&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="s">&#39;phone_of_found_person&#39;</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
            <span class="n">record</span><span class="p">[</span><span class="s">&#39;phone_of_found_person&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</div>
<div class="viewcode-block" id="get_secret"><a class="viewcode-back" href="../utils.html#admin_api_keys.get_secret">[docs]</a><span class="k">def</span> <span class="nf">get_secret</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets a secret from the datastore by name, or returns None if missing.&quot;&quot;&quot;</span>
    <span class="n">secret</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Secret</span><span class="o">.</span><span class="n">get_by_key_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">secret</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">secret</span><span class="o">.</span><span class="n">secret</span>

<span class="c"># The current time for testing as a datetime object, or None if using real time.</span></div>
<span class="n">_utcnow_for_test</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="set_utcnow_for_test"><a class="viewcode-back" href="../utils.html#admin_api_keys.set_utcnow_for_test">[docs]</a><span class="k">def</span> <span class="nf">set_utcnow_for_test</span><span class="p">(</span><span class="n">now</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets the current time for testing purposes.  Pass in a datetime object</span>
<span class="sd">    or a timestamp in epoch seconds; or pass None to revert to real time.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_utcnow_for_test</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">now</span><span class="p">))</span>
    <span class="n">_utcnow_for_test</span> <span class="o">=</span> <span class="n">now</span>
</div>
<div class="viewcode-block" id="get_utcnow"><a class="viewcode-back" href="../utils.html#admin_api_keys.get_utcnow">[docs]</a><span class="k">def</span> <span class="nf">get_utcnow</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns the current UTC datetime (settable with set_utcnow_for_test).&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_utcnow_for_test</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">_utcnow_for_test</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="ow">or</span> <span class="n">_utcnow_for_test</span>
</div>
<div class="viewcode-block" id="get_timestamp"><a class="viewcode-back" href="../utils.html#admin_api_keys.get_timestamp">[docs]</a><span class="k">def</span> <span class="nf">get_timestamp</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts datetime object to a float value in epoch seconds.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">utctimetuple</span><span class="p">())</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">*</span> <span class="mf">1e-6</span>
</div>
<div class="viewcode-block" id="get_utcnow_timestamp"><a class="viewcode-back" href="../utils.html#admin_api_keys.get_utcnow_timestamp">[docs]</a><span class="k">def</span> <span class="nf">get_utcnow_timestamp</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns the current time in epoch seconds (settable with</span>
<span class="sd">    set_utcnow_for_test).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_timestamp</span><span class="p">(</span><span class="n">get_utcnow</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="log_api_action"><a class="viewcode-back" href="../utils.html#admin_api_keys.log_api_action">[docs]</a><span class="k">def</span> <span class="nf">log_api_action</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">num_person_records</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_note_records</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">people_skipped</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">notes_skipped</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Log an API action.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="n">handler</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">api_action_logging</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ApiActionLog</span><span class="o">.</span><span class="n">record_action</span><span class="p">(</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="n">handler</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span>
            <span class="n">num_person_records</span><span class="p">,</span> <span class="n">num_note_records</span><span class="p">,</span>
            <span class="n">people_skipped</span><span class="p">,</span> <span class="n">notes_skipped</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;User-Agent&#39;</span><span class="p">),</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">,</span> <span class="n">handler</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="get_full_name"><a class="viewcode-back" href="../utils.html#admin_api_keys.get_full_name">[docs]</a><span class="k">def</span> <span class="nf">get_full_name</span><span class="p">(</span><span class="n">given_name</span><span class="p">,</span> <span class="n">family_name</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return full name string obtained by concatenating given_name and</span>
<span class="sd">    family_name in the order specified by config.family_name_first, or just</span>
<span class="sd">    given_name if config.use_family_name is False.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">use_family_name</span><span class="p">:</span>
        <span class="n">separator</span> <span class="o">=</span> <span class="p">(</span><span class="n">given_name</span> <span class="ow">and</span> <span class="n">family_name</span><span class="p">)</span> <span class="ow">and</span> <span class="s">u&#39; &#39;</span> <span class="ow">or</span> <span class="s">u&#39;&#39;</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">family_name_first</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">separator</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">family_name</span><span class="p">,</span> <span class="n">given_name</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">separator</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">given_name</span><span class="p">,</span> <span class="n">family_name</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">given_name</span>
</div>
<div class="viewcode-block" id="send_confirmation_email_to_record_author"><a class="viewcode-back" href="../utils.html#admin_api_keys.send_confirmation_email_to_record_author">[docs]</a><span class="k">def</span> <span class="nf">send_confirmation_email_to_record_author</span><span class="p">(</span>
    <span class="n">handler</span><span class="p">,</span> <span class="n">person</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">confirm_url</span><span class="p">,</span> <span class="n">record_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Send the author an email to confirm enabling/disabling notes</span>
<span class="sd">    of a record.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">person</span><span class="o">.</span><span class="n">author_email</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">handler</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="mi">400</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;No author email for record </span><span class="si">%(id)s</span><span class="s">.&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">{</span><span class="s">&#39;id&#39;</span> <span class="p">:</span> <span class="n">record_id</span><span class="p">})</span>

    <span class="c"># i18n: Subject line of an e-mail message confirming the author</span>
    <span class="c"># wants to disable notes for this record</span>
    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s">&#39;enable&#39;</span><span class="p">:</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;[Person Finder] Enable notes on &quot;</span><span class="si">%(full_name)s</span><span class="s">&quot;?&#39;</span>
                <span class="p">)</span> <span class="o">%</span> <span class="p">{</span><span class="s">&#39;full_name&#39;</span><span class="p">:</span> <span class="n">person</span><span class="o">.</span><span class="n">primary_full_name</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s">&#39;disable&#39;</span><span class="p">:</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;[Person Finder] Disable notes on &quot;</span><span class="si">%(full_name)s</span><span class="s">&quot;?&#39;</span>
                <span class="p">)</span> <span class="o">%</span> <span class="p">{</span><span class="s">&#39;full_name&#39;</span><span class="p">:</span> <span class="n">person</span><span class="o">.</span><span class="n">primary_full_name</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unknown action: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">action</span><span class="p">)</span>

    <span class="c"># send e-mail to record author confirming the lock of this record.</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_notes_email.txt&#39;</span> <span class="o">%</span> <span class="n">action</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">send_mail</span><span class="p">(</span>
        <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
        <span class="n">to</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">author_email</span><span class="p">,</span>
        <span class="n">body</span><span class="o">=</span><span class="n">handler</span><span class="o">.</span><span class="n">render_to_string</span><span class="p">(</span>
            <span class="n">template_name</span><span class="p">,</span>
            <span class="n">author_name</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">author_name</span><span class="p">,</span>
            <span class="n">full_name</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">primary_full_name</span><span class="p">,</span>
            <span class="n">site_url</span><span class="o">=</span><span class="n">handler</span><span class="o">.</span><span class="n">get_url</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">),</span>
            <span class="n">confirm_url</span><span class="o">=</span><span class="n">confirm_url</span>
        <span class="p">)</span>
    <span class="p">)</span>
</div>
<div class="viewcode-block" id="get_repo_url"><a class="viewcode-back" href="../utils.html#admin_api_keys.get_repo_url">[docs]</a><span class="k">def</span> <span class="nf">get_repo_url</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constructs the absolute root URL for a given repository.&quot;&quot;&quot;</span>
    <span class="n">req_scheme</span><span class="p">,</span> <span class="n">req_netloc</span><span class="p">,</span> <span class="n">req_path</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">req_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;/personfinder&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s">&#39;/personfinder&#39;</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">req_netloc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;localhost&#39;</span><span class="p">:</span>
        <span class="n">scheme</span> <span class="o">=</span> <span class="s">&#39;http&#39;</span>  <span class="c"># HTTPS is not available when using dev_appserver</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">scheme</span> <span class="ow">or</span> <span class="n">req_scheme</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;://&#39;</span> <span class="o">+</span> <span class="n">req_netloc</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">repo</span>
</div>
<div class="viewcode-block" id="get_url"><a class="viewcode-back" href="../utils.html#admin_api_keys.get_url">[docs]</a><span class="k">def</span> <span class="nf">get_url</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constructs the absolute URL for a given action and query parameters,</span>
<span class="sd">    preserving the current repo and the parameters listed in</span>
<span class="sd">    PRESERVED_QUERY_PARAM_NAMES.&quot;&quot;&quot;</span>
    <span class="n">repo_url</span> <span class="o">=</span> <span class="n">get_repo_url</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">repo</span> <span class="ow">or</span> <span class="s">&#39;global&#39;</span><span class="p">,</span> <span class="n">scheme</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">PRESERVED_QUERY_PARAM_NAMES</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">charset</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">repo_url</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">action</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">query</span> <span class="ow">and</span> <span class="s">&#39;?&#39;</span> <span class="o">+</span> <span class="n">query</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="add_profile_icon_url"><a class="viewcode-back" href="../utils.html#admin_api_keys.add_profile_icon_url">[docs]</a><span class="k">def</span> <span class="nf">add_profile_icon_url</span><span class="p">(</span><span class="n">website</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
    <span class="n">website</span><span class="p">[</span><span class="s">&#39;icon_url&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">handler</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">global_url</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">website</span><span class="p">[</span><span class="s">&#39;icon_filename&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">website</span>
</div>
<div class="viewcode-block" id="strip_url_scheme"><a class="viewcode-back" href="../utils.html#admin_api_keys.strip_url_scheme">[docs]</a><span class="k">def</span> <span class="nf">strip_url_scheme</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">url</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">segment</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlunsplit</span><span class="p">((</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">segment</span><span class="p">))</span>


<span class="c"># ==== Struct ==================================================================</span>
</div>
<div class="viewcode-block" id="Struct"><a class="viewcode-back" href="../utils.html#admin_api_keys.Struct">[docs]</a><span class="k">class</span> <span class="nc">Struct</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A simple bag of attributes.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="Struct.get"><a class="viewcode-back" href="../utils.html#admin_api_keys.Struct.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>


<span class="c"># ==== Key management ======================================================</span>
</div></div>
<div class="viewcode-block" id="generate_random_key"><a class="viewcode-back" href="../utils.html#admin_api_keys.generate_random_key">[docs]</a><span class="k">def</span> <span class="nf">generate_random_key</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates a random key with given length.&quot;&quot;&quot;</span>
    <span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;abcdefghijklmnopqrstuvwxyz&#39;</span>
              <span class="s">&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span>
              <span class="s">&#39;1234567890&#39;</span>
              <span class="s">&#39;-_&#39;</span><span class="p">)</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">SystemRandom</span><span class="p">()</span>
    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="get_secret_key"><a class="viewcode-back" href="../utils.html#admin_api_keys.get_secret_key">[docs]</a><span class="k">def</span> <span class="nf">get_secret_key</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;reveal&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the secret key for authorizing reveal operations etc.&quot;&quot;&quot;</span>
    <span class="n">secret</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Secret</span><span class="o">.</span><span class="n">get_by_key_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">secret</span><span class="p">:</span>
        <span class="n">secret</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Secret</span><span class="p">(</span><span class="n">key_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                              <span class="n">secret</span><span class="o">=</span><span class="n">generate_random_key</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
        <span class="n">secret</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">secret</span><span class="o">.</span><span class="n">secret</span>


<span class="c"># ==== Decorators  ============================================================</span>
</div>
<div class="viewcode-block" id="require_api_key_management_permission"><a class="viewcode-back" href="../utils.html#admin_api_keys.require_api_key_management_permission">[docs]</a><span class="k">def</span> <span class="nf">require_api_key_management_permission</span><span class="p">(</span><span class="n">handler_method</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a decorator for API Key management feature. The limitation</span>
<span class="sd">    is that the decorator can not preserve payloads within a POST/PUT</span>
<span class="sd">    request.</span>

<span class="sd">    Usage:</span>
<span class="sd">    class SomeHandler(utils.BaseHandler):</span>
<span class="sd">        @utils.require_api_key_management_permission</span>
<span class="sd">        def get(self):</span>
<span class="sd">            # ....</span>
<span class="sd">            # ....</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">is_current_user_admin</span><span class="p">()</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">user</span> <span class="ow">and</span> <span class="n">handler</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">key_management_operators</span> <span class="ow">and</span>
             <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">()</span> <span class="ow">in</span> <span class="n">handler</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">key_management_operators</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">handler_method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">handler</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span>
                <span class="n">users</span><span class="o">.</span><span class="n">create_login_url</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">inner</span>


<span class="c"># ==== Base Handler ============================================================</span>
</div>
<div class="viewcode-block" id="BaseHandler"><a class="viewcode-back" href="../utils.html#admin_api_keys.BaseHandler">[docs]</a><span class="k">class</span> <span class="nc">BaseHandler</span><span class="p">(</span><span class="n">webapp</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="c"># Handlers that don&#39;t need a repository name can set this to False.</span>
    <span class="n">repo_required</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c"># Handlers that require HTTPS can set this to True.</span>
    <span class="n">https_required</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c"># Set this to True to enable a handler even for deactivated repositories.</span>
    <span class="n">ignore_deactivation</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c"># Handlers that require an admin permission must set this to True.</span>
    <span class="n">admin_required</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c"># List all accepted query parameters here with their associated validators.</span>
    <span class="n">auto_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;add_note&#39;</span><span class="p">:</span> <span class="n">validate_yes</span><span class="p">,</span>
        <span class="s">&#39;age&#39;</span><span class="p">:</span> <span class="n">validate_age</span><span class="p">,</span>
        <span class="s">&#39;alternate_family_names&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;alternate_given_names&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;author_email&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;author_made_contact&#39;</span><span class="p">:</span> <span class="n">validate_yes</span><span class="p">,</span>
        <span class="s">&#39;author_name&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;author_phone&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;believed_dead_permission&#39;</span><span class="p">:</span> <span class="n">validate_checkbox_as_bool</span><span class="p">,</span>
        <span class="s">&#39;cache_seconds&#39;</span><span class="p">:</span> <span class="n">validate_cache_seconds</span><span class="p">,</span>
        <span class="s">&#39;clone&#39;</span><span class="p">:</span> <span class="n">validate_yes</span><span class="p">,</span>
        <span class="s">&#39;confirm&#39;</span><span class="p">:</span> <span class="n">validate_yes</span><span class="p">,</span>
        <span class="s">&#39;contact_email&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;contact_name&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;content_id&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;context&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;cursor&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;date_of_birth&#39;</span><span class="p">:</span> <span class="n">validate_approximate_date</span><span class="p">,</span>
        <span class="s">&#39;description&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;domain_write_permission&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;dupe_notes&#39;</span><span class="p">:</span> <span class="n">validate_yes</span><span class="p">,</span>
        <span class="s">&#39;email_of_found_person&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;error&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;expiry_option&#39;</span><span class="p">:</span> <span class="n">validate_expiry</span><span class="p">,</span>
        <span class="s">&#39;family_name&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;full_read_permission&#39;</span><span class="p">:</span> <span class="n">validate_checkbox_as_bool</span><span class="p">,</span>
        <span class="s">&#39;given_name&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;home_city&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;home_country&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;home_neighborhood&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;home_postal_code&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;home_state&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;home_street&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;id1&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;id2&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;id3&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;is_valid&#39;</span><span class="p">:</span> <span class="n">validate_checkbox_as_bool</span><span class="p">,</span>
        <span class="s">&#39;key&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;lang&#39;</span><span class="p">:</span> <span class="n">validate_lang</span><span class="p">,</span>
        <span class="s">&#39;last_known_location&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;mark_notes_reviewed&#39;</span><span class="p">:</span> <span class="n">validate_checkbox_as_bool</span><span class="p">,</span>
        <span class="s">&#39;max_results&#39;</span><span class="p">:</span> <span class="n">validate_int</span><span class="p">,</span>
        <span class="s">&#39;min_entry_date&#39;</span><span class="p">:</span> <span class="n">validate_datetime</span><span class="p">,</span>
        <span class="s">&#39;new_repo&#39;</span><span class="p">:</span> <span class="n">validate_repo</span><span class="p">,</span>
        <span class="s">&#39;note_photo&#39;</span><span class="p">:</span> <span class="n">validate_image</span><span class="p">,</span>
        <span class="s">&#39;note_photo_url&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;omit_notes&#39;</span><span class="p">:</span> <span class="n">validate_yes</span><span class="p">,</span>
        <span class="s">&#39;operation&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;organization_name&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;person_record_id&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;phone_of_found_person&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;photo&#39;</span><span class="p">:</span> <span class="n">validate_image</span><span class="p">,</span>
        <span class="s">&#39;photo_url&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;profile_url1&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;profile_url2&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;profile_url3&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;query&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;query_type&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;read_permission&#39;</span><span class="p">:</span> <span class="n">validate_checkbox_as_bool</span><span class="p">,</span>
        <span class="s">&#39;referrer&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;resource_bundle&#39;</span><span class="p">:</span> <span class="n">validate_resource_name</span><span class="p">,</span>
        <span class="s">&#39;resource_bundle_default&#39;</span><span class="p">:</span> <span class="n">validate_resource_name</span><span class="p">,</span>
        <span class="s">&#39;resource_bundle_original&#39;</span><span class="p">:</span> <span class="n">validate_resource_name</span><span class="p">,</span>
        <span class="s">&#39;resource_lang&#39;</span><span class="p">:</span> <span class="n">validate_lang</span><span class="p">,</span>
        <span class="s">&#39;resource_name&#39;</span><span class="p">:</span> <span class="n">validate_resource_name</span><span class="p">,</span>
        <span class="s">&#39;role&#39;</span><span class="p">:</span> <span class="n">validate_role</span><span class="p">,</span>
        <span class="s">&#39;search_engine_id&#39;</span><span class="p">:</span> <span class="n">validate_int</span><span class="p">,</span>
        <span class="s">&#39;search_permission&#39;</span><span class="p">:</span> <span class="n">validate_checkbox_as_bool</span><span class="p">,</span>
        <span class="s">&#39;sex&#39;</span><span class="p">:</span> <span class="n">validate_sex</span><span class="p">,</span>
        <span class="s">&#39;signature&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;skip&#39;</span><span class="p">:</span> <span class="n">validate_int</span><span class="p">,</span>
        <span class="s">&#39;small&#39;</span><span class="p">:</span> <span class="n">validate_yes</span><span class="p">,</span>
        <span class="s">&#39;source&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;source_date&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;source_name&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;source_url&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;stats_permission&#39;</span><span class="p">:</span> <span class="n">validate_checkbox_as_bool</span><span class="p">,</span>
        <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="n">validate_status</span><span class="p">,</span>
        <span class="s">&#39;style&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;subscribe&#39;</span><span class="p">:</span> <span class="n">validate_checkbox</span><span class="p">,</span>
        <span class="s">&#39;subscribe_email&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;subscribe_permission&#39;</span><span class="p">:</span> <span class="n">validate_checkbox_as_bool</span><span class="p">,</span>
        <span class="s">&#39;suppress_redirect&#39;</span><span class="p">:</span> <span class="n">validate_yes</span><span class="p">,</span>
        <span class="s">&#39;target&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;text&#39;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
        <span class="s">&#39;ui&#39;</span><span class="p">:</span> <span class="n">strip_and_lower</span><span class="p">,</span>
        <span class="s">&#39;utcnow&#39;</span><span class="p">:</span> <span class="n">validate_timestamp</span><span class="p">,</span>
        <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="n">validate_version</span><span class="p">,</span>
    <span class="p">}</span>

<div class="viewcode-block" id="BaseHandler.redirect"><a class="viewcode-back" href="../utils.html#admin_api_keys.BaseHandler.redirect">[docs]</a>    <span class="k">def</span> <span class="nf">redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">repo</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="c"># This will prepend the repo to the path to create a working URL,</span>
        <span class="c"># unless the path has a global prefix or is an absolute URL.</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;^[a-z]+:&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="ow">or</span> <span class="n">GLOBAL_PATH_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
              <span class="n">path</span> <span class="o">+=</span> <span class="s">&#39;?&#39;</span> <span class="o">+</span> <span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_url</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">webapp</span><span class="o">.</span><span class="n">RequestHandler</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="n">permanent</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseHandler.render"><a class="viewcode-back" href="../utils.html#admin_api_keys.BaseHandler.render">[docs]</a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">language_override</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cache_seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
               <span class="n">get_vars</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{},</span> <span class="o">**</span><span class="nb">vars</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Renders a template to the output stream, passing in the variables</span>
<span class="sd">        specified in **vars as well as any additional variables returned by</span>
<span class="sd">        get_vars().  Since this is intended for use by a dynamic page handler,</span>
<span class="sd">        caching is off by default; if cache_seconds is positive, then</span>
<span class="sd">        get_vars() will be called only when cached content is unavailable.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">render_to_string</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">language_override</span><span class="p">,</span> <span class="n">cache_seconds</span><span class="p">,</span> <span class="n">get_vars</span><span class="p">,</span> <span class="o">**</span><span class="nb">vars</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="BaseHandler.render_to_string"><a class="viewcode-back" href="../utils.html#admin_api_keys.BaseHandler.render_to_string">[docs]</a>    <span class="k">def</span> <span class="nf">render_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">language_override</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cache_seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                         <span class="n">get_vars</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{},</span> <span class="o">**</span><span class="nb">vars</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Renders a template to a string, passing in the variables specified</span>
<span class="sd">        in **vars as well as any additional variables returned by get_vars().</span>
<span class="sd">        Since this is intended for use by a dynamic page handler, caching is</span>
<span class="sd">        off by default; if cache_seconds is positive, then get_vars() will be</span>
<span class="sd">        called only when cached content is unavailable.&quot;&quot;&quot;</span>
        <span class="c"># TODO(kpy): Make the contents of extra_key overridable by callers?</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="n">language_override</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span>
        <span class="n">extra_key</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">charset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query_string</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">get_all_vars</span><span class="p">():</span>
            <span class="nb">vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_vars</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;env&#39;</span><span class="p">,</span> <span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="s">&#39;params&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s">&#39;Cannot use &quot;</span><span class="si">%s</span><span class="s">&quot; as a key in vars. It is reserved.&#39;</span>
                        <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
            <span class="nb">vars</span><span class="p">[</span><span class="s">&#39;env&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span>  <span class="c"># pass along application-wide context</span>
            <span class="nb">vars</span><span class="p">[</span><span class="s">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>  <span class="c"># pass along the configuration</span>
            <span class="nb">vars</span><span class="p">[</span><span class="s">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>  <span class="c"># pass along the query parameters</span>
            <span class="k">return</span> <span class="nb">vars</span>
        <span class="k">return</span> <span class="n">resources</span><span class="o">.</span><span class="n">get_rendered</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">extra_key</span><span class="p">,</span> <span class="n">get_all_vars</span><span class="p">,</span> <span class="n">cache_seconds</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseHandler.error"><a class="viewcode-back" href="../utils.html#admin_api_keys.BaseHandler.error">[docs]</a>    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">message_html</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">message_html</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&#39;error&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseHandler.info"><a class="viewcode-back" href="../utils.html#admin_api_keys.BaseHandler.info">[docs]</a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">message_html</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&#39;info&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Renders a simple page with a message.</span>

<span class="sd">        Args:</span>
<span class="sd">          code: HTTP status code.</span>
<span class="sd">          message: A message in plain text.</span>
<span class="sd">          message_html: A message in HTML.</span>
<span class="sd">          style: &#39;info&#39;, &#39;error&#39; or &#39;plain&#39;. &#39;info&#39; and &#39;error&#39; differs in</span>
<span class="sd">              appearance. &#39;plain&#39; just renders the message without extra</span>
<span class="sd">              HTML tags. Good for API response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_error</span> <span class="o">=</span> <span class="mi">400</span> <span class="o">&lt;=</span> <span class="n">code</span> <span class="o">&lt;</span> <span class="mi">600</span>
        <span class="k">if</span> <span class="n">is_error</span><span class="p">:</span>
            <span class="n">webapp</span><span class="o">.</span><span class="n">RequestHandler</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">message_html</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">httplib</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s">&#39;plain&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__render_plain_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">message_html</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;message.html&#39;</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">style</span><span class="p">,</span>
                            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">message_html</span><span class="o">=</span><span class="n">message_html</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__render_plain_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">message_html</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminate_response</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">__render_plain_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">message_html</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">django</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">+</span>
            <span class="p">(</span><span class="s">&#39;&lt;p&gt;&#39;</span> <span class="k">if</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">message_html</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">message_html</span><span class="p">)</span>

<div class="viewcode-block" id="BaseHandler.terminate_response"><a class="viewcode-back" href="../utils.html#admin_api_keys.BaseHandler.terminate_response">[docs]</a>    <span class="k">def</span> <span class="nf">terminate_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prevents any further output from being written.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="BaseHandler.write"><a class="viewcode-back" href="../utils.html#admin_api_keys.BaseHandler.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sends text to the client using the charset from select_charset().&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">charset</span><span class="p">,</span> <span class="s">&#39;replace&#39;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="BaseHandler.get_url"><a class="viewcode-back" href="../utils.html#admin_api_keys.BaseHandler.get_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">repo</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructs the absolute URL for a given action and query parameters,</span>
<span class="sd">        preserving the current repo and the parameters listed in</span>
<span class="sd">        PRESERVED_QUERY_PARAM_NAMES.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">get_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">repo</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span>
                       <span class="n">charset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">charset</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="n">scheme</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="BaseHandler.add_task_for_repo"><a class="viewcode-back" href="../utils.html#admin_api_keys.BaseHandler.add_task_for_repo">[docs]</a>    <span class="k">def</span> <span class="nf">add_task_for_repo</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Queues up a task for an individual repository.&quot;&quot;&quot;</span>
        <span class="n">task_name</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">))</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="n">taskqueue</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">task_name</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseHandler.send_mail"><a class="viewcode-back" href="../utils.html#admin_api_keys.BaseHandler.send_mail">[docs]</a>    <span class="k">def</span> <span class="nf">send_mail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sends e-mail using a sender address that&#39;s allowed for this app.&quot;&quot;&quot;</span>
        <span class="n">app_id</span> <span class="o">=</span> <span class="n">get_app_name</span><span class="p">()</span>
        <span class="n">sender</span> <span class="o">=</span> <span class="s">&#39;Do not reply &lt;do-not-reply@</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">app_id</span><span class="p">,</span> <span class="n">EMAIL_DOMAIN</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Add mail task: recipient </span><span class="si">%r</span><span class="s">, subject </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">))</span>
        <span class="n">taskqueue</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">queue_name</span><span class="o">=</span><span class="s">&#39;send-mail&#39;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s">&#39;/global/admin/send_mail&#39;</span><span class="p">,</span>
                      <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;sender&#39;</span><span class="p">:</span> <span class="n">sender</span><span class="p">,</span>
                              <span class="s">&#39;to&#39;</span><span class="p">:</span> <span class="n">to</span><span class="p">,</span>
                              <span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="n">subject</span><span class="p">,</span>
                              <span class="s">&#39;body&#39;</span><span class="p">:</span> <span class="n">body</span><span class="p">})</span>
</div>
<div class="viewcode-block" id="BaseHandler.get_captcha_html"><a class="viewcode-back" href="../utils.html#admin_api_keys.BaseHandler.get_captcha_html">[docs]</a>    <span class="k">def</span> <span class="nf">get_captcha_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_code</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_ssl</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates the necessary HTML to display a CAPTCHA validation box.&quot;&quot;&quot;</span>

        <span class="c"># We use the &#39;custom_translations&#39; parameter for UI messages, whereas</span>
        <span class="c"># the &#39;lang&#39; parameter controls the language of the challenge itself.</span>
        <span class="c"># reCAPTCHA falls back to &#39;en&#39; if this parameter isn&#39;t recognized.</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">captcha</span><span class="o">.</span><span class="n">get_display_html</span><span class="p">(</span>
            <span class="n">site_key</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;captcha_site_key&#39;</span><span class="p">),</span>
            <span class="n">use_ssl</span><span class="o">=</span><span class="n">use_ssl</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error_code</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="n">lang</span>
        <span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseHandler.get_captcha_response"><a class="viewcode-back" href="../utils.html#admin_api_keys.BaseHandler.get_captcha_response">[docs]</a>    <span class="k">def</span> <span class="nf">get_captcha_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an object containing the CAPTCHA response information for the</span>
<span class="sd">        given request&#39;s CAPTCHA field information.&quot;&quot;&quot;</span>
        <span class="n">captcha_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;g-recaptcha-response&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">captcha</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">captcha_response</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseHandler.handle_exception"><a class="viewcode-back" href="../utils.html#admin_api_keys.BaseHandler.handle_exception">[docs]</a>    <span class="k">def</span> <span class="nf">handle_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">debug_mode</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span>
            <span class="s">&#39;There was an error processing your request.  Sorry for the &#39;</span>
            <span class="s">&#39;inconvenience.  Our administrators will investigate the source &#39;</span>
            <span class="s">&#39;of the problem, but please check that the format of your &#39;</span>
            <span class="s">&#39;request is correct.&#39;</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">__get_env_language_for_babel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">language_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span>
        <span class="c"># A hack to avoid rejecting zh-hk locale.</span>
        <span class="c"># This corresponds to the hack with LANGUAGE_SYNONYMS in const.py.</span>
        <span class="c"># TODO: remove these 2 lines when a original code can be passed to here.</span>
        <span class="k">if</span> <span class="n">language_code</span> <span class="o">==</span> <span class="s">&#39;zhhk&#39;</span><span class="p">:</span>
            <span class="n">language_code</span> <span class="o">=</span> <span class="s">&#39;zh-hk&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">babel</span><span class="o">.</span><span class="n">Locale</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">language_code</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">babel</span><span class="o">.</span><span class="n">UnknownLocaleError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c"># fallback language</span>
            <span class="k">return</span> <span class="n">babel</span><span class="o">.</span><span class="n">Locale</span><span class="p">(</span><span class="s">&#39;en&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="BaseHandler.to_local_time"><a class="viewcode-back" href="../utils.html#admin_api_keys.BaseHandler.to_local_time">[docs]</a>    <span class="k">def</span> <span class="nf">to_local_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts a datetime object to the local time configured for the</span>
<span class="sd">        current repository.  For convenience, returns None if date is None.&quot;&quot;&quot;</span>
        <span class="c"># TODO(kpy): This only works for repositories that have a single fixed</span>
        <span class="c"># time zone offset and never use Daylight Saving Time.</span>
        <span class="k">if</span> <span class="n">date</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_zone_offset</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3600</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_zone_offset</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">date</span>
</div>
<div class="viewcode-block" id="BaseHandler.format_datetime_localized"><a class="viewcode-back" href="../utils.html#admin_api_keys.BaseHandler.format_datetime_localized">[docs]</a>    <span class="k">def</span> <span class="nf">format_datetime_localized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Formats a datetime object to a localized human-readable string based</span>
<span class="sd">        on the current locale.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">format_datetime</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__get_env_language_for_babel</span><span class="p">());</span>
</div>
<div class="viewcode-block" id="BaseHandler.to_formatted_local_time"><a class="viewcode-back" href="../utils.html#admin_api_keys.BaseHandler.to_formatted_local_time">[docs]</a>    <span class="k">def</span> <span class="nf">to_formatted_local_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts a datetime object to the local time configured for the</span>
<span class="sd">        current repository and formats to a localized human-readable string</span>
<span class="sd">        based on the current locale.&quot;&quot;&quot;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_local_time</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_datetime_localized</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseHandler.maybe_redirect_for_repo_alias"><a class="viewcode-back" href="../utils.html#admin_api_keys.BaseHandler.maybe_redirect_for_repo_alias">[docs]</a>    <span class="k">def</span> <span class="nf">maybe_redirect_for_repo_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If the specified repository name is an alias, redirects to the URL</span>
<span class="sd">        with the canonical repository name and returns True. Otherwise returns</span>
<span class="sd">        False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Config repo_alias is a dictionary from a repository name alias to</span>
        <span class="c"># its canonical.</span>
        <span class="c"># e.g., {&#39;yol&#39;: &#39;2013-yolanda&#39;, &#39;jam&#39;: &#39;2014-jammu-kashmir-floods&#39;}</span>
        <span class="c">#</span>
        <span class="c"># A repository name alias can be used instead of the canonical</span>
        <span class="c"># repository name in URLs. This is especially useful combined with</span>
        <span class="c"># the short URL. e.g., You can access</span>
        <span class="c"># https://www.google.org/personfinder/2014-jammu-kashmir-floods</span>
        <span class="c"># by http://g.co/pf/jam .</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">repo_aliases</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;repo_aliases&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">{})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span> <span class="ow">in</span> <span class="n">repo_aliases</span><span class="p">:</span>
            <span class="n">canonical_repo</span> <span class="o">=</span> <span class="n">repo_aliases</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">]</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">arguments</span><span class="p">():</span>
                <span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="c"># Redirects to the same URL including the query parameters, except</span>
            <span class="c"># for the repository name.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="n">repo</span><span class="o">=</span><span class="n">canonical_repo</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminate_response</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="n">webapp</span><span class="o">.</span><span class="n">RequestHandler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">Struct</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">repo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charset</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">charset</span>

        <span class="c"># Set default Content-Type header.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&#39;text/html; charset=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset</span><span class="p">)</span>

        <span class="c"># Validate query parameters.</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">validator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">validator</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">validator</span><span class="p">(</span><span class="bp">None</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s">&#39;Invalid parameter </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

        <span class="c"># Ensure referrer is in whitelist, if it exists</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">referrer</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">referrer</span> <span class="ow">in</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">referrer_whitelist</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="s">&#39;referrer&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="c"># Log the User-Agent header.</span>
        <span class="n">sample_rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">user_agent_sample_rate</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">sample_rate</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">UserAgentLog</span><span class="p">(</span>
                <span class="n">repo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span>
                <span class="n">user_agent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;User-Agent&#39;</span><span class="p">),</span> <span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="p">,</span>
                <span class="n">accept_charset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Accept-Charset&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span>
                <span class="n">ip_address</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">)</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>

        <span class="c"># Check for SSL (unless running on localhost for development).</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">https_required</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">domain</span> <span class="o">!=</span> <span class="s">&#39;localhost&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">scheme</span> <span class="o">!=</span> <span class="s">&#39;https&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s">&#39;HTTPS is required.&#39;</span><span class="p">)</span>

        <span class="c"># Handles repository alias.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybe_redirect_for_repo_alias</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c"># Check for an authorization key.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">:</span>
                <span class="c"># check for domain specific one.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Authorization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">:</span>
                <span class="c"># perhaps this is a global key (&#39;*&#39; for consistency with config).</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Authorization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># Shows a custom error page here when the user is not an admin</span>
        <span class="c"># instead of &quot;login: admin&quot; in app.yaml</span>
        <span class="c"># If we use it, user can&#39;t sign out </span>
        <span class="c"># because the error page of &quot;login: admin&quot; doesn&#39;t have sign-out link.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_required</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
                <span class="n">login_url</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">create_login_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
                <span class="n">webapp</span><span class="o">.</span><span class="n">RequestHandler</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login_url</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">terminate_response</span><span class="p">()</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">users</span><span class="o">.</span><span class="n">is_current_user_admin</span><span class="p">():</span>
                <span class="n">logout_url</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">create_logout_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;not_admin_error.html&#39;</span><span class="p">,</span> <span class="n">logout_url</span><span class="o">=</span><span class="n">logout_url</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">terminate_response</span><span class="p">()</span>
                <span class="k">return</span>

        <span class="c"># Handlers that don&#39;t need a repository configuration can skip it.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo_required</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s">&#39;No repository specified.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c"># Everything after this requires a repo.</span>

        <span class="c"># Reject requests for repositories that don&#39;t exist.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">Repo</span><span class="o">.</span><span class="n">get_by_key_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">):</span>
            <span class="n">html</span> <span class="o">=</span> <span class="s">&#39;No such repository. &#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">repo_options</span><span class="p">:</span>
                <span class="n">html</span> <span class="o">+=</span> <span class="s">&#39;Select:&lt;p&gt;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_to_string</span><span class="p">(</span><span class="s">&#39;repo-menu.html&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="n">message_html</span><span class="o">=</span><span class="n">html</span><span class="p">)</span>

        <span class="c"># If this repository has been deactivated, terminate with a message.</span>
        <span class="c"># The ignore_deactivation flag is for admin pages that bypass this.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">deactivated</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_deactivation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">language_menu</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">robots_ok</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;message.html&#39;</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="s">&#39;deactivation&#39;</span><span class="p">,</span>
                        <span class="n">message_html</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">deactivation_message_html</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminate_response</span><span class="p">()</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.6</a>
      
    </div>

    

    
  </body>
</html>